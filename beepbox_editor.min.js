var beepbox,__extends=this&&this.t||function(){var t=function(i,s){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var s in i)i.hasOwnProperty(s)&&(t[s]=i[s])})(i,s)};return function(i,s){function h(){this.constructor=i}t(i,s),i.prototype=null===s?Object.create(s):(h.prototype=s.prototype,new h)}}();!function(t){var i=function(){function t(t,i,s,h){this.i=[],this.s=0;for(var n=s;n<h;n++){var e=t[i.charCodeAt(n)];this.i.push(e>>5&1),this.i.push(e>>4&1),this.i.push(e>>3&1),this.i.push(e>>2&1),this.i.push(e>>1&1),this.i.push(1&e)}}return t.prototype.read=function(t){for(var i=0;t>0;)i<<=1,i+=this.i[this.s++],t--;return i},t.prototype.readLongTail=function(t,i){for(var s=t,h=i;this.i[this.s++];)s+=1<<h,h++;for(;h>0;)h--,this.i[this.s++]&&(s+=1<<h);return s},t.prototype.readPartDuration=function(){return this.readLongTail(1,2)},t.prototype.readPinCount=function(){return this.readLongTail(1,0)},t.prototype.readPitchInterval=function(){return this.read(1)?-this.readLongTail(1,3):this.readLongTail(1,3)},t}(),s=function(){function t(){this.i=[]}return t.prototype.write=function(t,i){for(t--;t>=0;)this.i.push(i>>>t&1),t--},t.prototype.writeLongTail=function(t,i,s){if(s<t)throw new Error("value out of bounds");s-=t;for(var h=i;s>=1<<h;)this.i.push(1),s-=1<<h,h++;for(this.i.push(0);h>0;)h--,this.i.push(s>>>h&1)},t.prototype.writePartDuration=function(t){this.writeLongTail(1,2,t)},t.prototype.writePinCount=function(t){this.writeLongTail(1,0,t)},t.prototype.writePitchInterval=function(t){t<0?(this.write(1,1),this.writeLongTail(1,3,-t)):(this.write(1,0),this.writeLongTail(1,3,t))},t.prototype.concat=function(t){this.i=this.i.concat(t.i)},t.prototype.encodeBase64=function(t,i){for(var s=0;s<this.i.length;s+=6){var h=this.i[s]<<5|this.i[s+1]<<4|this.i[s+2]<<3|this.i[s+3]<<2|this.i[s+4]<<1|this.i[s+5];i.push(t[h])}return i},t.prototype.lengthBase64=function(){return Math.ceil(this.i.length/6)},t}(),h=function(){function t(){}return t.scaleNames=["easy :)","easy :(","island :)","island :(","blues :)","blues :(","normal :)","normal :(","dbl harmonic :)","dbl harmonic :(","enigma","expert"],t.scaleFlags=[[!0,!1,!0,!1,!0,!1,!1,!0,!1,!0,!1,!1],[!0,!1,!1,!0,!1,!0,!1,!0,!1,!1,!0,!1],[!0,!1,!1,!1,!0,!0,!1,!0,!1,!1,!1,!0],[!0,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!1],[!0,!1,!0,!0,!0,!1,!1,!0,!1,!0,!1,!1],[!0,!1,!1,!0,!1,!0,!0,!0,!1,!1,!0,!1],[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0],[!0,!1,!0,!0,!1,!0,!1,!0,!0,!1,!0,!1],[!0,!0,!1,!1,!0,!0,!1,!0,!0,!1,!1,!0],[!0,!1,!0,!0,!1,!1,!0,!0,!0,!1,!1,!0],[!0,!1,!0,!1,!0,!1,!0,!1,!0,!1,!0,!1],[!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0,!0]],t.pianoScaleFlags=[!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0],t.blackKeyNameParents=[-1,1,-1,1,-1,1,-1,-1,1,-1,1,-1],t.pitchNames=["C",null,"D",null,"E","F",null,"G",null,"A",null,"B"],t.keyNames=["B","A♯","A","G♯","G","F♯","F","E","D♯","D","C♯","C"],t.keyTransposes=[23,22,21,20,19,18,17,16,15,14,13,12],t.tempoNames=["molasses","slow","leisurely","moderate","steady","brisk","hasty","fast","strenuous","grueling","hyper","ludicrous"],t.reverbRange=4,t.beatsMin=3,t.beatsMax=15,t.barsMin=1,t.barsMax=128,t.patternsMin=1,t.patternsMax=64,t.instrumentsMin=1,t.instrumentsMax=10,t.partNames=["triples","standard"],t.partCounts=[3,4],t.waveNames=["triangle","square","pulse wide","pulse narrow","sawtooth","double saw","double pulse","spiky","plateau"],t.waveVolumes=[1,.5,.5,.5,.65,.5,.4,.4,.94],t.drumNames=["retro","white"],t.drumVolumes=[.25,1],t.filterNames=["sustain sharp","sustain medium","sustain soft","decay sharp","decay medium","decay soft"],t.filterBases=[2,3.5,5,1,2.5,4],t.filterDecays=[0,0,0,10,7,4],t.filterVolumes=[.4,.7,1,.5,.75,1],t.envelopeNames=["seamless","sudden","smooth","slide"],t.effectNames=["none","vibrato light","vibrato delayed","vibrato heavy","tremelo light","tremelo heavy"],t.effectVibratos=[0,.15,.3,.45,0,0],t.effectTremelos=[0,0,0,0,.25,.5],t.chorusNames=["union","shimmer","hum","honky tonk","dissonant","fifths","octaves","bowed"],t.chorusValues=[0,.02,.05,.1,.25,3.5,6,.02],t.chorusOffsets=[0,0,0,0,0,3.5,6,0],t.chorusVolumes=[.7,.8,1,1,.9,.9,.8,1],t.volumeNames=["loudest","loud","medium","quiet","quietest","mute"],t.volumeValues=[0,.5,1,1.5,2,-1],t.channelVolumes=[.27,.27,.27,.19],t.drumInterval=6,t.numChannels=4,t.drumCount=12,t.pitchCount=37,t.maxPitch=84,t}();function n(t,i,s){return{interval:t,time:i,volume:s}}function e(t,i,s,h,e){return void 0===e&&(e=!1),{pitches:[t],pins:[n(0,0,h),n(0,s-i,e?0:h)],start:i,end:s}}t.Music=h,t.makeNotePin=n,t.makeNote=e;var r=function(){function t(){this.notes=[],this.instrument=0}return t.prototype.cloneNotes=function(){for(var t=[],i=0,s=this.notes;i<s.length;i++){var h=s[i],r=e(-1,h.start,h.end,3);r.pitches=h.pitches.concat(),r.pins=[];for(var o=0,a=h.pins;o<a.length;o++){var u=a[o];r.pins.push(n(u.interval,u.time,u.volume))}t.push(r)}return t},t}();t.BarPattern=r;var o=function(){function t(t){void 0!=t?this.fromBase64String(t):this.initToDefault()}return t.prototype.initToDefault=function(){this.channelPatterns=[[new r,new r,new r,new r,new r,new r,new r,new r],[new r,new r,new r,new r,new r,new r,new r,new r],[new r,new r,new r,new r,new r,new r,new r,new r],[new r,new r,new r,new r,new r,new r,new r,new r]],this.channelBars=[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],this.channelOctaves=[3,2,1,0],this.instrumentVolumes=[[0],[0],[0],[0]],this.instrumentWaves=[[1],[1],[1],[1]],this.instrumentFilters=[[0],[0],[0],[0]],this.instrumentEnvelopes=[[1],[1],[1],[1]],this.instrumentEffects=[[0],[0],[0],[0]],this.instrumentChorus=[[0],[0],[0],[0]],this.scale=0,this.key=h.keyNames.length-1,this.loopStart=0,this.loopLength=4,this.tempo=7,this.reverb=0,this.beats=8,this.bars=16,this.patterns=8,this.parts=4,this.instruments=1},t.prototype.toBase64String=function(){var i,n=[],e=t.h;n.push(e[t.o]),n.push(115,e[this.scale]),n.push(107,e[this.key]),n.push(108,e[this.loopStart>>6],e[63&this.loopStart]),n.push(101,e[this.loopLength-1>>6],e[this.loopLength-1&63]),n.push(116,e[this.tempo]),n.push(109,e[this.reverb]),n.push(97,e[this.beats-1]),n.push(103,e[this.bars-1>>6],e[this.bars-1&63]),n.push(106,e[this.patterns-1]),n.push(105,e[this.instruments-1]),n.push(114,e[h.partCounts.indexOf(this.parts)]),n.push(119);for(var r=0;r<h.numChannels;r++)for(var o=0;o<this.instruments;o++)n.push(e[this.instrumentWaves[r][o]]);n.push(102);for(r=0;r<h.numChannels;r++)for(o=0;o<this.instruments;o++)n.push(e[this.instrumentFilters[r][o]]);n.push(100);for(r=0;r<h.numChannels;r++)for(o=0;o<this.instruments;o++)n.push(e[this.instrumentEnvelopes[r][o]]);n.push(99);for(r=0;r<h.numChannels;r++)for(o=0;o<this.instruments;o++)n.push(e[this.instrumentEffects[r][o]]);n.push(104);for(r=0;r<h.numChannels;r++)for(o=0;o<this.instruments;o++)n.push(e[this.instrumentChorus[r][o]]);n.push(118);for(r=0;r<h.numChannels;r++)for(o=0;o<this.instruments;o++)n.push(e[this.instrumentVolumes[r][o]]);n.push(111);for(r=0;r<h.numChannels;r++)n.push(e[this.channelOctaves[r]]);n.push(98),i=new s;for(var a=0;1<<a<this.patterns+1;)a++;for(r=0;r<h.numChannels;r++)for(o=0;o<this.bars;o++)i.write(a,this.channelBars[r][o]);i.encodeBase64(e,n),n.push(112),i=new s;for(var u=0;1<<u<this.instruments;)u++;for(r=0;r<h.numChannels;r++){var l=3==r?0:12*this.channelOctaves[r],c=(3==r?4:12)+l,f=3==r?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],v=[];for(o=0;o<f.length;o++)f[o]+=l;for(var d=0,b=this.channelPatterns[r];d<b.length;d++){var w=b[d];if(i.write(u,w.instrument),w.notes.length>0){i.write(1,1);for(var p=0,m=0,g=w.notes;m<g.length;m++){var M=g[m];M.start>p&&(i.write(2,0),i.writePartDuration(M.start-p));var y=new s;for(o=1;o<M.pitches.length;o++)y.write(1,1);M.pitches.length<4&&y.write(1,0),y.writePinCount(M.pins.length-1),y.write(2,M.pins[0].volume);var x=0,A=M.pitches[0],k=A,N=[];for(o=1;o<M.pins.length;o++){var E=M.pins[o],Z=A+E.interval;k!=Z?(y.write(1,1),N.push(Z),k=Z):y.write(1,0),y.writePartDuration(E.time-x),x=E.time,y.write(2,E.volume)}var R=String.fromCharCode.apply(null,y.encodeBase64(e,[])),I=v.indexOf(R);-1==I?(i.write(2,1),i.concat(y)):(i.write(1,1),i.writeLongTail(0,0,I),v.splice(I,1)),v.unshift(R),v.length>10&&v.pop();var G=M.pitches.concat(N);for(o=0;o<G.length;o++){var B=G[o],S=f.indexOf(B);if(-1==S){var C=0,j=c;if(j<B)for(;j!=B;)j++,-1==f.indexOf(j)&&C++;else for(;j!=B;)j--,-1==f.indexOf(j)&&C--;i.write(1,0),i.writePitchInterval(C)}else i.write(1,1),i.write(3,S),f.splice(S,1);f.unshift(B),f.length>8&&f.pop(),c=o==M.pitches.length-1?M.pitches[0]:B}p=M.end}p<this.beats*this.parts&&(i.write(2,0),i.writePartDuration(this.beats*this.parts-p))}else i.write(1,0)}}for(var D=i.lengthBase64(),U=[];D>0;)U.unshift(e[63&D]),D>>=6;return n.push(e[U.length]),Array.prototype.push.apply(n,U),i.encodeBase64(e,n),String.fromCharCode.apply(null,n)},t.prototype.fromBase64String=function(s){if(null!=s){for(var o=0;s.charCodeAt(o)<=32;)o++;if(35==s.charCodeAt(o)&&o++,123!=s.charCodeAt(o)){this.initToDefault();var a=t.u[s.charCodeAt(o++)];if(!(-1==a||a>t.o||a<t.l)){var u=a<3,l=a<4,c=a<5,f=t.u;for(u&&(this.instrumentEnvelopes=[[0],[0],[0],[0]]),u&&(this.instrumentWaves=[[1],[1],[1],[0]]);o<s.length;){var v=s.charCodeAt(o++),d=void 0;if(115==v)this.scale=f[s.charCodeAt(o++)],u&&10==this.scale&&(this.scale=11);else if(107==v)this.key=f[s.charCodeAt(o++)];else if(108==v)this.loopStart=c?f[s.charCodeAt(o++)]:(f[s.charCodeAt(o++)]<<6)+f[s.charCodeAt(o++)];else if(101==v)this.loopLength=c?f[s.charCodeAt(o++)]:(f[s.charCodeAt(o++)]<<6)+f[s.charCodeAt(o++)]+1;else if(116==v)this.tempo=l?[1,4,7,10][f[s.charCodeAt(o++)]]:f[s.charCodeAt(o++)],this.tempo=this.v(0,h.tempoNames.length,this.tempo);else if(109==v)this.reverb=f[s.charCodeAt(o++)],this.reverb=this.v(0,h.reverbRange,this.reverb);else if(97==v)this.beats=u?[6,7,8,9,10][f[s.charCodeAt(o++)]]:f[s.charCodeAt(o++)]+1,this.beats=Math.max(h.beatsMin,Math.min(h.beatsMax,this.beats));else if(103==v)this.bars=(f[s.charCodeAt(o++)]<<6)+f[s.charCodeAt(o++)]+1,this.bars=Math.max(h.barsMin,Math.min(h.barsMax,this.bars));else if(106==v)this.patterns=f[s.charCodeAt(o++)]+1,this.patterns=Math.max(h.patternsMin,Math.min(h.patternsMax,this.patterns));else if(105==v)this.instruments=f[s.charCodeAt(o++)]+1,this.instruments=Math.max(h.instrumentsMin,Math.min(h.instrumentsMax,this.instruments));else if(114==v)this.parts=h.partCounts[f[s.charCodeAt(o++)]];else if(119==v)if(u)d=f[s.charCodeAt(o++)],this.instrumentWaves[d][0]=this.v(0,h.waveNames.length,f[s.charCodeAt(o++)]);else for(d=0;d<h.numChannels;d++)for(var b=0;b<this.instruments;b++)this.instrumentWaves[d][b]=this.v(0,h.waveNames.length,f[s.charCodeAt(o++)]);else if(102==v)if(u)d=f[s.charCodeAt(o++)],this.instrumentFilters[d][0]=[0,2,3,5][this.v(0,h.filterNames.length,f[s.charCodeAt(o++)])];else for(d=0;d<h.numChannels;d++)for(b=0;b<this.instruments;b++)this.instrumentFilters[d][b]=this.v(0,h.filterNames.length,f[s.charCodeAt(o++)]);else if(100==v)if(u)d=f[s.charCodeAt(o++)],this.instrumentEnvelopes[d][0]=this.v(0,h.envelopeNames.length,f[s.charCodeAt(o++)]);else for(d=0;d<h.numChannels;d++)for(b=0;b<this.instruments;b++)this.instrumentEnvelopes[d][b]=this.v(0,h.envelopeNames.length,f[s.charCodeAt(o++)]);else if(99==v)if(u)d=f[s.charCodeAt(o++)],this.instrumentEffects[d][0]=this.v(0,h.effectNames.length,f[s.charCodeAt(o++)]),1==this.instrumentEffects[d][0]?this.instrumentEffects[d][0]=3:3==this.instrumentEffects[d][0]&&(this.instrumentEffects[d][0]=5);else for(d=0;d<h.numChannels;d++)for(b=0;b<this.instruments;b++)this.instrumentEffects[d][b]=this.v(0,h.effectNames.length,f[s.charCodeAt(o++)]);else if(104==v)if(u)d=f[s.charCodeAt(o++)],this.instrumentChorus[d][0]=this.v(0,h.chorusNames.length,f[s.charCodeAt(o++)]);else for(d=0;d<h.numChannels;d++)for(b=0;b<this.instruments;b++)this.instrumentChorus[d][b]=this.v(0,h.chorusNames.length,f[s.charCodeAt(o++)]);else if(118==v)if(u)d=f[s.charCodeAt(o++)],this.instrumentVolumes[d][0]=this.v(0,h.volumeNames.length,f[s.charCodeAt(o++)]);else for(d=0;d<h.numChannels;d++)for(b=0;b<this.instruments;b++)this.instrumentVolumes[d][b]=this.v(0,h.volumeNames.length,f[s.charCodeAt(o++)]);else if(111==v)if(u)d=f[s.charCodeAt(o++)],this.channelOctaves[d]=this.v(0,5,f[s.charCodeAt(o++)]);else for(d=0;d<h.numChannels;d++)this.channelOctaves[d]=this.v(0,5,f[s.charCodeAt(o++)]);else if(98==v){var w=void 0;if(u){d=f[s.charCodeAt(o++)];var p=f[s.charCodeAt(o++)];w=Math.ceil(.5*p);var m=new i(f,s,o,o+w);for(b=0;b<p;b++)this.channelBars[d][b]=m.read(3)+1}else if(c){for(var g=0;1<<g<this.patterns;)g++;w=Math.ceil(h.numChannels*this.bars*g/6);m=new i(f,s,o,o+w);for(d=0;d<h.numChannels;d++){this.channelBars[d].length=this.bars;for(b=0;b<this.bars;b++)this.channelBars[d][b]=m.read(g)+1}}else{for(var M=0;1<<M<this.patterns+1;)M++;w=Math.ceil(h.numChannels*this.bars*M/6);m=new i(f,s,o,o+w);for(d=0;d<h.numChannels;d++){this.channelBars[d].length=this.bars;for(b=0;b<this.bars;b++)this.channelBars[d][b]=m.read(M)}}o+=w}else if(112==v){var y=0;if(u)d=f[s.charCodeAt(o++)],o++,y=f[s.charCodeAt(o++)],y<<=6,y+=f[s.charCodeAt(o++)];else{d=0;for(var x=f[s.charCodeAt(o++)];x>0;)y<<=6,y+=f[s.charCodeAt(o++)],x--}m=new i(f,s,o,o+y);o+=y;for(var A=0;1<<A<this.instruments;)A++;for(;;){this.channelPatterns[d]=[];var k=3==d?0:12*this.channelOctaves[d],N=null,E=null,Z=(3==d?4:12)+k,R=3==d?[4,6,7,2,3,8,0,10]:[12,19,24,31,36,7,0],I=[];for(b=0;b<R.length;b++)R[b]+=k;for(b=0;b<this.patterns;b++){var G=new r;if(G.instrument=m.read(A),this.channelPatterns[d][b]=G,u||0!=m.read(1)){for(var B=0,S=[];B<this.beats*this.parts;){var C=1==m.read(1),j=!1,D=0;if(C?D=m.readLongTail(0,0):j=1==m.read(1),C||j){var U=void 0,Y=void 0,z=void 0;if(C)U=I[D],I.splice(D,1);else{for((U={}).pitchCount=1;U.pitchCount<4&&1==m.read(1);)U.pitchCount++;U.pinCount=m.readPinCount(),U.initialVolume=m.read(2),U.pins=[],U.length=0,U.bendCount=0;for(var L=0;L<U.pinCount;L++)(Y={}).pitchBend=1==m.read(1),Y.pitchBend&&U.bendCount++,U.length+=m.readPartDuration(),Y.time=U.length,Y.volume=m.read(2),U.pins.push(Y)}I.unshift(U),I.length>10&&I.pop(),(N=e(0,B,B+U.length,U.initialVolume)).pitches=[],N.pins.length=1;var V=[];for(L=0;L<U.pitchCount+U.bendCount;L++){if(1==m.read(1)){var F=m.read(3);z=R[F],R.splice(F,1)}else{var W=m.readPitchInterval();z=Z;for(var J=W;J>0;){for(z++;-1!=R.indexOf(z);)z++;J--}for(;J<0;){for(z--;-1!=R.indexOf(z);)z--;J++}}R.unshift(z),R.length>8&&R.pop(),L<U.pitchCount?N.pitches.push(z):V.push(z),Z=L==U.pitchCount-1?N.pitches[0]:z}V.unshift(N.pitches[0]);for(var T=0,O=U.pins;T<O.length;T++){var P=O[T];P.pitchBend&&V.shift(),E=n(V[0]-N.pitches[0],P.time,P.volume),N.pins.push(E)}B=N.end,S.push(N)}else{B+=m.readPartDuration()}}G.notes=S}}if(u)break;if(++d>=h.numChannels)break}}}}}else this.fromJsonObject(JSON.parse(0==o?s:s.substring(o)))}else this.initToDefault()},t.prototype.toJsonObject=function(i,s,n){void 0===i&&(i=!0),void 0===s&&(s=1),void 0===n&&(n=!0);for(var e=[],r=0;r<h.numChannels;r++){for(var o=[],a=0;a<this.instruments;a++)3==r?o.push({volume:20*(5-this.instrumentVolumes[r][a]),wave:h.drumNames[this.instrumentWaves[r][a]],envelope:h.envelopeNames[this.instrumentEnvelopes[r][a]]}):o.push({volume:20*(5-this.instrumentVolumes[r][a]),wave:h.waveNames[this.instrumentWaves[r][a]],envelope:h.envelopeNames[this.instrumentEnvelopes[r][a]],filter:h.filterNames[this.instrumentFilters[r][a]],chorus:h.chorusNames[this.instrumentChorus[r][a]],effect:h.effectNames[this.instrumentEffects[r][a]]});for(var u=[],l=0,c=this.channelPatterns[r];l<c.length;l++){for(var f=c[l],v=[],d=0,b=f.notes;d<b.length;d++){for(var w=b[d],p=[],m=0,g=w.pins;m<g.length;m++){var M=g[m];p.push({tick:M.time+w.start,pitchBend:M.interval,volume:Math.round(100*M.volume/3)})}v.push({pitches:w.pitches,points:p})}u.push({instrument:f.instrument+1,pitches:v})}var y=[];if(i)for(a=0;a<this.loopStart;a++)y.push(this.channelBars[r][a]);for(var x=0;x<s;x++)for(a=this.loopStart;a<this.loopStart+this.loopLength;a++)y.push(this.channelBars[r][a]);if(n)for(a=this.loopStart+this.loopLength;a<this.bars;a++)y.push(this.channelBars[r][a]);e.push({octaveScrollBar:this.channelOctaves[r],instruments:o,patterns:u,sequence:y})}return{version:t.o,scale:h.scaleNames[this.scale],key:h.keyNames[this.key],introBars:this.loopStart,loopBars:this.loopLength,beatsPerBar:this.beats,ticksPerBeat:this.parts,beatsPerMinute:this.getBeatsPerMinute(),reverb:this.reverb,channels:e}},t.prototype.fromJsonObject=function(t){if((this.initToDefault(),t)&&5===t.version){if(this.scale=11,void 0!=t.scale){var i=h.scaleNames.indexOf(t.scale);-1!=i&&(this.scale=i)}if(void 0!=t.key)if("number"==typeof t.key)this.key=h.keyNames.length-1-(t.key+1200>>>0)%h.keyNames.length;else if("string"==typeof t.key){var s=t.key,o=s.charAt(0).toUpperCase(),a=s.charAt(1).toLowerCase(),u={C:11,D:9,E:7,F:6,G:4,A:2,B:0}[o],l={"#":-1,"♯":-1,b:1,"♭":1}[a];void 0!=u&&(void 0!=l&&(u+=l),u<0&&(u+=12),u%=12,this.key=u)}if(void 0!=t.beatsPerMinute){var c=0|t.beatsPerMinute;this.tempo=Math.round(4+9*Math.log(c/120)/Math.LN2),this.tempo=this.v(0,h.tempoNames.length,this.tempo)}void 0!=t.reverb&&(this.reverb=this.v(0,h.reverbRange,0|t.reverb)),void 0!=t.beatsPerBar&&(this.beats=Math.max(h.beatsMin,Math.min(h.beatsMax,0|t.beatsPerBar))),void 0!=t.ticksPerBeat&&(this.parts=Math.max(3,Math.min(4,0|t.ticksPerBeat)));for(var f=1,v=1,d=1,b=0;b<h.numChannels;b++){if(t.channels&&t.channels[b])(w=t.channels[b]).instruments&&(f=Math.max(f,0|w.instruments.length)),w.patterns&&(v=Math.max(v,0|w.patterns.length)),w.sequence&&(d=Math.max(d,0|w.sequence.length))}this.instruments=f,this.patterns=v,this.bars=d,void 0!=t.introBars&&(this.loopStart=this.v(0,this.bars,0|t.introBars)),void 0!=t.loopBars&&(this.loopLength=this.v(1,this.bars-this.loopStart+1,0|t.loopBars));for(b=0;b<h.numChannels;b++){var w=void 0;t.channels&&(w=t.channels[b]),void 0==w&&(w={}),void 0!=w.octaveScrollBar&&(this.channelOctaves[b]=this.v(0,5,0|w.octaveScrollBar)),this.instrumentVolumes[b].length=this.instruments,this.instrumentWaves[b].length=this.instruments,this.instrumentEnvelopes[b].length=this.instruments,this.instrumentFilters[b].length=this.instruments,this.instrumentChorus[b].length=this.instruments,this.instrumentEffects[b].length=this.instruments,this.channelPatterns[b].length=this.patterns,this.channelBars[b].length=this.bars;for(var p=0;p<this.instruments;p++){var m=void 0;w.instruments&&(m=w.instruments[p]),void 0==m&&(m={}),void 0!=m.volume?this.instrumentVolumes[b][p]=this.v(0,h.volumeNames.length,Math.round(5-(0|m.volume)/20)):this.instrumentVolumes[b][p]=0,this.instrumentEnvelopes[b][p]=h.envelopeNames.indexOf(m.envelope),-1==this.instrumentEnvelopes[b][p]&&(this.instrumentEnvelopes[b][p]=1),3==b?(this.instrumentWaves[b][p]=h.drumNames.indexOf(m.wave),-1==this.instrumentWaves[b][p]&&(this.instrumentWaves[b][p]=0),this.instrumentFilters[b][p]=0,this.instrumentChorus[b][p]=0,this.instrumentEffects[b][p]=0):(this.instrumentWaves[b][p]=h.waveNames.indexOf(m.wave),-1==this.instrumentWaves[b][p]&&(this.instrumentWaves[b][p]=1),this.instrumentFilters[b][p]=h.filterNames.indexOf(m.filter),-1==this.instrumentFilters[b][p]&&(this.instrumentFilters[b][p]=0),this.instrumentChorus[b][p]=h.chorusNames.indexOf(m.chorus),-1==this.instrumentChorus[b][p]&&(this.instrumentChorus[b][p]=0),this.instrumentEffects[b][p]=h.effectNames.indexOf(m.effect),-1==this.instrumentEffects[b][p]&&(this.instrumentEffects[b][p]=0))}for(p=0;p<this.patterns;p++){var g=new r;this.channelPatterns[b][p]=g;var M=void 0;if(w.patterns&&(M=w.patterns[p]),void 0!=M&&(g.instrument=this.v(0,this.instruments,(0|M.instrument)-1),M.pitches&&M.pitches.length>0))for(var y=Math.min(this.beats*this.parts,M.pitches.length>>>0),x=0,A=0;A<M.pitches.length&&!(A>=y);A++){var k=M.pitches[A];if(k&&k.pitches&&k.pitches.length>=1&&k.points&&k.points.length>=2){var N=e(0,0,0,0);N.pitches=[],N.pins=[];for(var E=0;E<k.pitches.length;E++){var Z=0|k.pitches[E];if(-1==N.pitches.indexOf(Z)&&(N.pitches.push(Z),N.pitches.length>=4))break}if(!(N.pitches.length<1)){var R=x,I=0;for(E=0;E<k.points.length;E++){var G=k.points[E];if(void 0!=G&&void 0!=G.tick){var B=void 0==G.pitchBend?0:0|G.pitchBend,S=0|G.tick,C=void 0==G.volume?3:Math.max(0,Math.min(3,Math.round(3*(0|G.volume)/100)));if(!(S>this.beats*this.parts)){if(0==N.pins.length){if(S<R)continue;N.start=S,I=B}else if(S<=R)continue;R=S,N.pins.push(n(B-I,S-N.start,C))}}}if(!(N.pins.length<2)){N.end=N.pins[N.pins.length-1].time+N.start;var j=3==b?h.drumCount-1:h.maxPitch,D=j,U=0;for(E=0;E<N.pitches.length;E++)N.pitches[E]+=I,(N.pitches[E]<0||N.pitches[E]>j)&&(N.pitches.splice(E,1),E--),N.pitches[E]<D&&(D=N.pitches[E]),N.pitches[E]>U&&(U=N.pitches[E]);if(!(N.pitches.length<1)){for(E=0;E<N.pins.length;E++){var Y=N.pins[E];Y.interval+D<0&&(Y.interval=-D),Y.interval+U>j&&(Y.interval=j-U),E>=2&&Y.interval==N.pins[E-1].interval&&Y.interval==N.pins[E-2].interval&&Y.volume==N.pins[E-1].volume&&Y.volume==N.pins[E-2].volume&&(N.pins.splice(E-1,1),E--)}g.notes.push(N),x=N.end}}}}}}for(p=0;p<this.bars;p++)this.channelBars[b][p]=w.sequence?Math.min(this.patterns,w.sequence[p]>>>0):0}}},t.prototype.v=function(t,i,s){return s<=(i-=1)?s>=t?s:t:i},t.prototype.getPattern=function(t,i){var s=this.channelBars[t][i];return 0==s?null:this.channelPatterns[t][s-1]},t.prototype.getPatternInstrument=function(t,i){var s=this.getPattern(t,i);return null==s?0:s.instrument},t.prototype.getBeatsPerMinute=function(){return Math.round(120*Math.pow(2,(-4+this.tempo)/9))},t.l=2,t.o=5,t.u=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,62,62,0,0,1,2,3,4,5,6,7,8,9,0,0,0,0,0,0,0,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,0,0,0,0,63,0,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,0,0,0,0,0],t.h=[48,49,50,51,52,53,54,55,56,57,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,45,95],t}();t.Song=o;var a=function(){function t(t){var i=this;void 0===t&&(t=null),this.samplesPerSecond=44100,this.p=.14,this.m=2*Math.PI/(this.p*this.samplesPerSecond),this.g=2*Math.cos(this.m),this.M=1/(2*this.samplesPerSecond),this.k=[new Float64Array([1/15,.2,5/15,7/15,.6,11/15,13/15,1,1,13/15,11/15,.6,7/15,5/15,.2,1/15,-1/15,-.2,-5/15,-7/15,-.6,-11/15,-13/15,-1,-1,-13/15,-11/15,-.6,-7/15,-5/15,-.2,-1/15]),new Float64Array([1,-1]),new Float64Array([1,-1,-1,-1]),new Float64Array([1,-1,-1,-1,-1,-1,-1,-1]),new Float64Array([1/31,3/31,5/31,7/31,9/31,11/31,13/31,15/31,17/31,19/31,21/31,23/31,25/31,27/31,29/31,1,-1,-29/31,-27/31,-25/31,-23/31,-21/31,-19/31,-17/31,-15/31,-13/31,-11/31,-9/31,-7/31,-5/31,-3/31,-1/31]),new Float64Array([0,-.2,-.4,-.6,-.8,-1,1,-.8,-.6,-.4,-.2,1,.8,.6,.4,.2]),new Float64Array([1,1,1,1,1,-1,-1,-1,1,1,1,1,-1,-1,-1,-1]),new Float64Array([1,-1,1,-1,1,0]),new Float64Array([0,.2,.4,.5,.6,.7,.8,.85,.9,.95,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,.95,.9,.85,.8,.7,.6,.5,.4,.2,0,-.2,-.4,-.5,-.6,-.7,-.8,-.85,-.9,-.95,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-.95,-.9,-.85,-.8,-.7,-.6,-.5,-.4,-.2])],this.N=[new Float32Array(32767),new Float32Array(32767)],this.song=null,this.pianoPressed=!1,this.pianoPitch=0,this.pianoChannel=0,this.enableIntro=!0,this.enableOutro=!1,this.loopCount=-1,this.volume=1,this.Z=0,this.R=0,this.I=0,this.S=0,this.j=0,this.U=0,this.Y=!0,this.L=0,this.V=0,this.W=0,this.J=0,this.T=0,this.O=0,this.P=0,this.X=0,this.H=0,this.K=0,this._=0,this.q=1,this.$=!1,this.tt=0,this.it=0,this.st=new Float32Array(16384),this.ht=0,this.nt=0,this.et=0,this.rt=0,this.ot=0,this.at=function(t){var s=t.outputBuffer,h=s.getChannelData(0);i.synthesize(h,s.length)};for(var s=0,h=this.k;s<h.length;s++){for(var n=h[s],e=0,r=0;r<n.length;r++)e+=n[r];var o=e/n.length;for(r=0;r<n.length;r++)n[r]-=o}for(var a=0;a<this.N.length;a++){n=this.N[a];if(0==a){var u=1;for(r=0;r<32767;r++){n[r]=2*(1&u)-1;var l=u>>1;1==(u+l&1)&&(l+=16384),u=l}}else if(1==a)for(r=0;r<32767;r++)n[r]=2*Math.random()-1}null!=t&&this.setSong(t)}return Object.defineProperty(t.prototype,"playing",{get:function(){return!this.Y},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"playhead",{get:function(){return this.Z},set:function(t){if(null!=this.song){this.Z=Math.max(0,Math.min(this.song.bars,t));var i=this.Z;this.R=Math.floor(i),i=this.song.beats*(i-this.R),this.I=Math.floor(i),i=this.song.parts*(i-this.I),this.S=Math.floor(i),i=4*(i-this.S),this.j=Math.floor(i);var s=this.ut();i=s*(i-this.j),this.U=Math.floor(s-i),this.R<this.song.loopStart&&(this.enableIntro=!0),this.R>this.song.loopStart+this.song.loopLength&&(this.enableOutro=!0)}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalSamples",{get:function(){if(null==this.song)return 0;var t=4*this.ut()*this.song.parts*this.song.beats,i=this.loopCount;i<0&&(i=1);var s=this.song.loopLength*i;return this.enableIntro&&(s+=this.song.loopStart),this.enableOutro&&(s+=this.song.bars-(this.song.loopStart+this.song.loopLength)),s*t},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalSeconds",{get:function(){return this.totalSamples/this.samplesPerSecond},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"totalBars",{get:function(){return null==this.song?0:this.song.bars},enumerable:!0,configurable:!0}),t.prototype.setSong=function(t){"string"==typeof t?this.song=new o(t):t instanceof o&&(this.song=t)},t.prototype.play=function(){if(this.Y){this.Y=!1;var t=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext;this.lt=this.lt||new t,this.ct=this.lt.createScriptProcessor?this.lt.createScriptProcessor(2048,0,1):this.lt.createJavaScriptNode(2048,0,1),this.ct.onaudioprocess=this.at,this.ct.channelCountMode="explicit",this.ct.channelInterpretation="speakers",this.ct.connect(this.lt.destination),this.samplesPerSecond=this.lt.sampleRate,this.m=2*Math.PI/(this.p*this.samplesPerSecond),this.g=2*Math.cos(this.m),this.M=1/(2*this.samplesPerSecond)}},t.prototype.pause=function(){this.Y||(this.Y=!0,this.ct.disconnect(this.lt.destination),this.lt.close&&(this.lt.close(),this.lt=null),this.ct=null)},t.prototype.snapToStart=function(){this.R=0,this.enableIntro=!0,this.snapToBar()},t.prototype.snapToBar=function(){this.Z=this.R,this.I=0,this.S=0,this.j=0,this.U=0,this.tt=0,this.W=0,this.O=0,this.H=0,this._=0,this.ht=0,this.nt=0,this.et=0,this.rt=0,this.ot=0;for(var t=0;t<this.st.length;t++)this.st[t]=0},t.prototype.nextBar=function(){if(this.song){var t=this.R;this.R++,this.enableOutro?this.R>=this.song.bars&&(this.R=this.enableIntro?0:this.song.loopStart):(this.R>=this.song.loopStart+this.song.loopLength||this.R>=this.song.bars)&&(this.R=this.song.loopStart),this.Z+=this.R-t}},t.prototype.prevBar=function(){if(this.song){var t=this.R;this.R--,this.R<0&&(this.R=this.song.loopStart+this.song.loopLength-1),this.R>=this.song.bars&&(this.R=this.song.bars-1),this.R<this.song.loopStart&&(this.enableIntro=!0),!this.enableOutro&&this.R>=this.song.loopStart+this.song.loopLength&&(this.R=this.song.loopStart+this.song.loopLength-1),this.Z+=this.R-t}},t.prototype.synthesize=function(t,i){if(null!=this.song){var s=this.song,n=0,e=1/this.samplesPerSecond,r=this.ut(),o=this.g,a=this.M,u=this.volume,l=this.st,c=.425*Math.pow(s.reverb/h.reverbRange,.667),f=!1;for((0==this.U||this.U>r)&&(this.U=r),this.S>=s.parts&&(this.I++,this.S=0,this.j=0,this.U=r),this.I>=s.beats&&(this.R++,this.I=0,this.S=0,this.j=0,this.U=r,-1==this.loopCount&&(this.R<s.loopStart&&!this.enableIntro&&(this.R=s.loopStart),this.R>=s.loopStart+s.loopLength&&!this.enableOutro&&(this.R=s.loopStart))),this.R>=s.bars&&(this.enableOutro?(this.R=0,this.enableIntro=!0,f=!0,this.pause()):this.R=s.loopStart),this.R>=s.loopStart&&(this.enableIntro=!1);i>0;){if(f){for(;i-- >0;)t[n]=0,n++;break}var v=s.getPatternInstrument(0,this.R),d=s.getPatternInstrument(1,this.R),b=s.getPatternInstrument(2,this.R),w=s.getPatternInstrument(3,this.R),p=h.channelVolumes[0]*(5==s.instrumentVolumes[0][v]?0:Math.pow(2,-h.volumeValues[s.instrumentVolumes[0][v]]))*h.waveVolumes[s.instrumentWaves[0][v]]*h.filterVolumes[s.instrumentFilters[0][v]]*h.chorusVolumes[s.instrumentChorus[0][v]]*.5,m=h.channelVolumes[1]*(5==s.instrumentVolumes[1][d]?0:Math.pow(2,-h.volumeValues[s.instrumentVolumes[1][d]]))*h.waveVolumes[s.instrumentWaves[1][d]]*h.filterVolumes[s.instrumentFilters[1][d]]*h.chorusVolumes[s.instrumentChorus[0][d]]*.5,g=h.channelVolumes[2]*(5==s.instrumentVolumes[2][b]?0:Math.pow(2,-h.volumeValues[s.instrumentVolumes[2][b]]))*h.waveVolumes[s.instrumentWaves[2][b]]*h.filterVolumes[s.instrumentFilters[2][b]]*h.chorusVolumes[s.instrumentChorus[0][b]]*.5,M=h.channelVolumes[3]*(5==s.instrumentVolumes[3][w]?0:Math.pow(2,-h.volumeValues[s.instrumentVolumes[3][w]]))*h.drumVolumes[s.instrumentWaves[3][w]],y=this.k[s.instrumentWaves[0][v]],x=this.k[s.instrumentWaves[1][d]],A=this.k[s.instrumentWaves[2][b]],k=this.N[s.instrumentWaves[3][w]],N=y.length,E=x.length,Z=A.length,R=Math.pow(2,-h.filterBases[s.instrumentFilters[0][v]]),I=Math.pow(2,-h.filterBases[s.instrumentFilters[1][d]]),G=Math.pow(2,-h.filterBases[s.instrumentFilters[2][b]]),B=1,S=h.effectTremelos[s.instrumentEffects[0][v]],C=h.effectTremelos[s.instrumentEffects[1][d]],j=h.effectTremelos[s.instrumentEffects[2][b]],D=Math.pow(2,(h.chorusOffsets[s.instrumentChorus[0][v]]+h.chorusValues[s.instrumentChorus[0][v]])/12),U=Math.pow(2,(h.chorusOffsets[s.instrumentChorus[1][d]]+h.chorusValues[s.instrumentChorus[1][d]])/12),Y=Math.pow(2,(h.chorusOffsets[s.instrumentChorus[2][b]]+h.chorusValues[s.instrumentChorus[2][b]])/12),z=Math.pow(2,(h.chorusOffsets[s.instrumentChorus[0][v]]-h.chorusValues[s.instrumentChorus[0][v]])/12),L=Math.pow(2,(h.chorusOffsets[s.instrumentChorus[1][d]]-h.chorusValues[s.instrumentChorus[1][d]])/12),V=Math.pow(2,(h.chorusOffsets[s.instrumentChorus[2][b]]-h.chorusValues[s.instrumentChorus[2][b]])/12),F=7==s.instrumentChorus[0][v]?-1:1,W=7==s.instrumentChorus[1][d]?-1:1,J=7==s.instrumentChorus[2][b]?-1:1;for(0==s.instrumentChorus[0][v]&&(this.V=this.L),0==s.instrumentChorus[1][d]&&(this.T=this.J),0==s.instrumentChorus[2][b]&&(this.X=this.P);i>0;){var T=void 0;i-=T=this.U<=i?this.U:i,this.U-=T;for(var O=0,P=0,Q=0,X=0,H=0,K=0,_=0,q=0,$=0,tt=0,it=0,st=0,ht=0,nt=0,et=0,rt=0,ot=0,at=0,ut=0,lt=0,ct=0,ft=0,vt=0,dt=0,bt=0,wt=this.S+this.I*s.parts,pt=0;pt<4;pt++){var mt=s.getPattern(pt,this.R),gt=null==mt?0:s.instrumentEnvelopes[pt][mt.instrument],Mt=null,yt=null,xt=null;if(null!=mt)for(qi=0;qi<mt.notes.length;qi++)if(mt.notes[qi].end<=wt)yt=mt.notes[qi];else if(mt.notes[qi].start<=wt&&mt.notes[qi].end>wt)Mt=mt.notes[qi];else if(mt.notes[qi].start>wt){xt=mt.notes[qi];break}null!=Mt&&null!=yt&&yt.end!=Mt.start&&(yt=null),null!=Mt&&null!=xt&&xt.start!=Mt.end&&(xt=null);var At=3==pt?69:h.keyTransposes[s.key],kt=3==pt?h.drumInterval:1,Nt=void 0,Et=void 0,Zt=void 0,Rt=void 0,It=void 0,Gt=void 0,Bt=void 0,St=!1;if(this.pianoPressed&&pt==this.pianoChannel){var Ct=this.ft(At+this.pianoPitch*kt),jt=mt?mt.instrument:0,Dt=void 0;3==pt?s.instrumentWaves[3][jt]>0?(B=Math.min(1,Ct*e*8),Dt=24):Dt=60:Dt=48,Nt=Ct*e,Et=1,Zt=Math.pow(2,-this.pianoPitch*kt/Dt),Rt=0,It=1,Gt=1,Bt=Math.pow(2,h.effectVibratos[s.instrumentEffects[pt][jt]]/12)-1}else if(null==Mt)Nt=0,Et=0,Zt=0,Rt=0,It=1,Gt=1,Bt=0,St=!0;else{var Ut=void 0;Ut=2==Mt.pitches.length?Mt.pitches[this.j>>1]:3==Mt.pitches.length?Mt.pitches[3==this.j?1:this.j]:4==Mt.pitches.length?Mt.pitches[this.j]:Mt.pitches[0];var Yt=void 0;for(Yt=1;Yt<Mt.pins.length-1&&!(Mt.pins[Yt].time+Mt.start>wt);Yt++);var zt=Mt.pins[Yt-1],Lt=Mt.pins[Yt],Vt=4*Mt.start,Ft=4*Mt.end,Wt=4*(Mt.start+zt.time),Jt=4*(Mt.start+Lt.time),Tt=4*wt+this.j,Ot=4*wt+this.j+1,Pt=(Tt-Wt)/(Jt-Wt),Qt=(Ot-Wt)/(Jt-Wt),Xt=zt.volume*(1-Pt)+Lt.volume*Pt,Ht=zt.volume*(1-Qt)+Lt.volume*Qt,Kt=zt.interval*(1-Pt)+Lt.interval*Pt,_t=zt.interval*(1-Qt)+Lt.interval*Qt,qt=zt.time*(1-Pt)+Lt.time*Pt,$t=zt.time*(1-Qt)+Lt.time*Qt,ti=!1;Tt==Vt&&(0==gt?ti=!0:2==gt?Xt=0:3==gt&&(null==yt||yt.pitches.length>1||Mt.pitches.length>1?Xt=0:0==yt.pins[yt.pins.length-1].volume||0==Mt.pins[0].volume?Xt=0:(Kt=.5*(yt.pitches[0]+yt.pins[yt.pins.length-1].interval-Ut),qt=.5*yt.pins[yt.pins.length-1].time,ti=!0))),Ot==Ft&&(1==gt||2==gt?Ht=0:3==gt&&(null==xt||xt.pitches.length>1||Mt.pitches.length>1?Ht=0:0==Mt.pins[Mt.pins.length-1].volume||0==xt.pins[0].volume?Xt=0:(_t=.5*(xt.pitches[0]+Mt.pins[Mt.pins.length-1].interval-Ut),$t*=.5)));var ii=1-(this.U+T)/r,si=1-this.U/r,hi=Kt*(1-ii)+_t*ii,ni=Kt*(1-si)+_t*si,ei=qt*(1-ii)+$t*ii,ri=qt*(1-si)+$t*si,oi=this.ft(At+(Ut+hi)*kt),ai=this.ft(At+(Ut+ni)*kt),ui=void 0;3==pt?s.instrumentWaves[3][mt.instrument]>0?(B=Math.min(1,oi*e*8),ui=24):ui=60:ui=48;var li=Math.pow(2,-(Ut+hi)*kt/ui),ci=Math.pow(2,-(Ut+ni)*kt/ui);li*=this.vt(Xt*(1-ii)+Ht*ii),ci*=this.vt(Xt*(1-si)+Ht*si);var fi=ai/oi;Nt=oi*e,Et=Math.pow(fi,1/T),Zt=li,Rt=(ci-li)/T,0!=(Tt+ii-Vt)*r/this.samplesPerSecond||ti||(St=!0);var vi=h.filterDecays[s.instrumentFilters[pt][mt.instrument]];It=Math.pow(2,-vi*ei*4*r/this.samplesPerSecond);var di=Math.pow(2,-vi*ri*4*r/this.samplesPerSecond);Gt=Math.pow(di/It,1/T),Bt=2==s.instrumentEffects[pt][mt.instrument]&&wt-Mt.start<3?0:Math.pow(2,h.effectVibratos[s.instrumentEffects[pt][mt.instrument]]/12)-1}0==pt?(O=Nt,P=Et,Q=Zt*p,X=Rt*p,H=It*R,K=Gt,_=Bt,St&&(this.W=0,this.L=0,this.V=0)):1==pt?(q=Nt,$=Et,tt=Zt*m,it=Rt*m,st=It*I,ht=Gt,nt=Bt,St&&(this.O=0,this.J=0,this.T=0)):2==pt?(et=Nt,rt=Et,ot=Zt*g,at=Rt*g,ut=It*G,lt=Gt,ct=Bt,St&&(this.H=0,this.P=0,this.X=0)):3==pt&&(ft=Nt/32767,vt=Et,dt=Zt*M,bt=Rt*M)}for(var bi=Math.sin(this.tt),wi=Math.sin(this.tt-this.m),pi=+this.W,mi=+this.L,gi=+this.V,Mi=+this.O,yi=+this.J,xi=+this.T,Ai=+this.H,ki=+this.P,Ni=+this.X,Ei=+this._,Zi=+this.K,Ri=0|this.ht,Ii=+this.nt,Gi=+this.et,Bi=+this.rt,Si=+this.ot,Ci=+this.it;T;){var ji=1+_*bi,Di=1+nt*bi,Ui=1+ct*bi,Yi=1+S*(bi-1),zi=1+C*(bi-1),Li=1+j*(bi-1),Vi=bi;bi=o*bi-wi,wi=Vi,pi+=((y[0|mi*N]+y[0|gi*N]*F)*Q*Yi-pi)*H,Mi+=((x[0|yi*E]+x[0|xi*E]*W)*tt*zi-Mi)*st,Ai+=((A[0|ki*Z]+A[0|Ni*Z]*J)*ot*Li-Ai)*ut,Ei+=(k[0|32767*Zi]*dt-Ei)*B,Q+=X,tt+=it,ot+=at,dt+=bt,mi+=O*ji*D,gi+=O*ji*z,yi+=q*Di*U,xi+=q*Di*L,ki+=et*Ui*Y,Ni+=et*Ui*V,Zi+=ft,O*=P,q*=$,et*=rt,ft*=vt,H*=K,st*=ht,ut*=lt,mi-=0|mi,gi-=0|gi,yi-=0|yi,xi-=0|xi,ki-=0|ki,Ni-=0|Ni,Zi-=0|Zi;var Fi=pi+Mi+Ai,Wi=l[Ri]+Fi,Ji=l[Ri+3041&16383],Ti=l[Ri+6426&16383],Oi=l[Ri+10907&16383],Pi=-Wi+Ji,Qi=-Wi-Ji,Xi=-Ti+Oi,Hi=-Ti-Oi;Ii+=.5*((Pi+Xi)*c-Ii),Gi+=.5*((Qi+Hi)*c-Gi),Bi+=.5*((Pi-Xi)*c-Bi),Si+=.5*((Qi-Hi)*c-Si),l[Ri+3041&16383]=Ii,l[Ri+6426&16383]=Gi,l[Ri+10907&16383]=Bi,l[Ri]=Si,Ri=Ri+1&16383;var Ki=Wi+Ji+Ti+Oi+Ei,_i=Ki<0?-Ki:Ki;(Ci-=a)<_i&&(Ci=_i),Ki/=.75*Ci+.25,Ki*=u,t[n]=Ki,n+=1,T--}if(this.W=pi,this.L=mi,this.V=gi,this.O=Mi,this.J=yi,this.T=xi,this.H=Ai,this.P=ki,this.X=Ni,this._=Ei,this.K=Zi,this.ht=Ri,this.nt=Ii,this.et=Gi,this.rt=Bi,this.ot=Si,this.it=Ci,this.tt=o*bi-wi>wi?Math.asin(bi):Math.PI-Math.asin(bi),0==this.U&&(this.j++,this.U=r,4==this.j&&(this.j=0,this.S++,this.S==s.parts&&(this.S=0,this.I++,this.I==s.beats)))){this.I=0,this.tt=0,this.R++,this.R<s.loopStart?this.enableIntro||(this.R=s.loopStart):this.enableIntro=!1,this.R>=s.loopStart+s.loopLength&&(this.loopCount>0&&this.loopCount--,(this.loopCount>0||!this.enableOutro)&&(this.R=s.loopStart)),this.R>=s.bars&&(this.R=0,this.enableIntro=!0,f=!0,this.pause());break}}}this.Z=(((this.j+1-this.U/r)/4+this.S)/s.parts+this.I)/s.beats+this.R}else for(var qi=0;qi<i;qi++)t[qi]=0},t.prototype.ft=function(t){return 440*Math.pow(2,(t-69)/12)},t.prototype.vt=function(t){return Math.pow(t/3,1.5)},t.prototype.ut=function(){if(null==this.song)return 0;var t=4*(this.song.getBeatsPerMinute()/60*this.song.parts);return Math.floor(this.samplesPerSecond/t)},t}();t.Synth=a}(beepbox||(beepbox={})),function(t){var i=function(){function t(){this.dt=[],this.bt=!1}return t.prototype.watch=function(t){-1==this.dt.indexOf(t)&&this.dt.push(t)},t.prototype.unwatch=function(t){var i=this.dt.indexOf(t);-1!=i&&this.dt.splice(i,1)},t.prototype.changed=function(){this.bt=!0},t.prototype.notifyWatchers=function(){if(this.bt){this.bt=!1;for(var t=0,i=this.dt.concat();t<i.length;t++){(0,i[t])()}}},t}();t.ChangeNotifier=i}(beepbox||(beepbox={})),function(t){var i=function(){function i(i){var s=this;this.history=this,this.notifier=new t.ChangeNotifier,this.channel=0,this.bar=0,this.volume=75,this.barScrollPos=0,this.prompt=null,this.wt=null,this.pt=0,this.gt=0,this.Mt=0,this.yt=!1,this.xt=!1,this.At=function(){var i=window.history.state;i&&i.sequenceNumber==s.pt||(null==i?(s.pt++,i={canUndo:!0,sequenceNumber:s.pt,bar:s.bar,channel:s.channel,prompt:s.prompt},new t.ChangeSong(s,location.hash),window.history.replaceState(i,"","#"+s.song.toBase64String())):(i.sequenceNumber==s.pt-1?(s.bar=s.gt,s.channel=s.Mt):i.sequenceNumber!=s.pt&&(s.bar=i.bar,s.channel=i.channel),s.pt=i.sequenceNumber,s.prompt=i.prompt,new t.ChangeSong(s,location.hash)),s.gt=i.bar,s.Mt=i.channel,s.forgetLastChange(),s.notifier.notifyWatchers())},this.kt=function(){s.notifier.notifyWatchers()},this.Nt=function(){s.xt=!1;var t,i="#"+s.song.toBase64String();s.yt?(s.pt++,t={canUndo:!0,sequenceNumber:s.pt,bar:s.bar,channel:s.channel,prompt:s.prompt},window.history.pushState(t,"",i)):(t={canUndo:!0,sequenceNumber:s.pt,bar:s.bar,channel:s.channel,prompt:s.prompt},window.history.replaceState(t,"",i)),s.gt=t.bar,s.Mt=t.channel,s.yt=!1},this.song=new t.Song(i),this.synth=new t.Synth(this.song),this.showFifth="true"==localStorage.getItem("showFifth"),this.showLetters="true"==localStorage.getItem("showLetters"),this.showChannels="true"==localStorage.getItem("showChannels"),this.showScrollBar="true"==localStorage.getItem("showScrollBar"),null!=localStorage.getItem("volume")&&(this.volume=Number(localStorage.getItem("volume"))),this.synth.volume=this.Et();var h=window.history.state;null==h&&(h={canUndo:!1,sequenceNumber:0,bar:0,channel:0,prompt:this.prompt},window.history.replaceState(h,"","#"+this.song.toBase64String())),window.addEventListener("hashchange",this.At),window.addEventListener("popstate",this.At),this.bar=h.bar,this.channel=h.channel,this.gt=h.bar,this.Mt=h.channel,this.barScrollPos=Math.max(0,this.bar-15);for(var n=0,e=["input","change","click","keyup","keydown","mousedown","mousemove","mouseup","touchstart","touchmove","touchend","touchcancel"];n<e.length;n++){var r=e[n];window.addEventListener(r,this.kt)}}return i.prototype.record=function(t,i){void 0===i&&(i=!1),t.isNoop()?(this.wt=null,i&&window.history.back()):(this.wt=t,this.yt=this.yt||!i,this.xt||(window.requestAnimationFrame(this.Nt),this.xt=!0))},i.prototype.openPrompt=function(t){this.prompt=t;var i="#"+this.song.toBase64String();this.pt++;var s={canUndo:!0,sequenceNumber:this.pt,bar:this.bar,channel:this.channel,prompt:this.prompt};window.history.pushState(s,"",i)},i.prototype.undo=function(){window.history.state.canUndo&&window.history.back()},i.prototype.redo=function(){window.history.forward()},i.prototype.setProspectiveChange=function(t){this.wt=t},i.prototype.forgetLastChange=function(){this.wt=null},i.prototype.lastChangeWas=function(t){return null!=t&&t==this.wt},i.prototype.savePreferences=function(){localStorage.setItem("showFifth",this.showFifth?"true":"false"),localStorage.setItem("showLetters",this.showLetters?"true":"false"),localStorage.setItem("showChannels",this.showChannels?"true":"false"),localStorage.setItem("showScrollBar",this.showScrollBar?"true":"false"),localStorage.setItem("volume",String(this.volume))},i.prototype.setVolume=function(t){this.volume=t,this.savePreferences(),this.synth.volume=this.Et()},i.prototype.Et=function(){return Math.min(1,Math.pow(this.volume/50,.5))*Math.pow(2,(this.volume-75)/25)},i.prototype.getCurrentPattern=function(){return this.song.getPattern(this.channel,this.bar)},i.prototype.getCurrentInstrument=function(){var t=this.getCurrentPattern();return null==t?0:t.instrument},i.o=2,i}();t.SongDocument=i}(beepbox||(beepbox={})),function(t){!function(t){function i(t,i,s){var h=document.createElement(t);if(i)for(var n=0,e=Object.keys(i);n<e.length;n++){var r=e[n];"style"==r?h.setAttribute(r,i[r]):h[r]=i[r]}if(s)for(var o=0,a=s;o<a.length;o++){var u=a[o];h.appendChild(u)}return h}function s(t){return document.createTextNode(t)}t.element=i,t.button=function(t,s){return i("button",t,s)},t.div=function(t,s){return i("div",t,s)},t.span=function(t,s){return i("span",t,s)},t.select=function(t,s){return i("select",t,s)},t.option=function(t,i,h,n){void 0===h&&(h=!1),void 0===n&&(n=!1);var e=document.createElement("option");return e.value=t,e.selected=h,e.disabled=n,e.appendChild(s(i)),e},t.canvas=function(t){return i("canvas",t)},t.input=function(t){return i("input",t)},t.br=function(){return i("br")},t.text=s}(t.html||(t.html={}));var i="http://www.w3.org/2000/svg";t.svgElement=function(t,s,h){var n=document.createElementNS(i,t);if(s)for(var e=0,r=Object.keys(s);e<r.length;e++){var o=r[e];n.setAttribute(o,s[o])}if(h)for(var a=0,u=h;a<u.length;a++){var l=u[a];n.appendChild(l)}return n}}(beepbox||(beepbox={})),function(t){var i=document.createElement("style");i.type="text/css",i.appendChild(document.createTextNode('\n\n.beepboxEditor {\n\t/* For some reason the default focus outline effect causes the entire editor to get repainted when any part of it changes. Border doesn\'t do that. */\n\tmargin: -3px;\n\tborder: 3px solid transparent;\n\twidth: 700px;\n\theight: 645px;\n\tdisplay: flex;\n\tflex-direction: row;\n\t-webkit-touch-callout: none;\n\t-webkit-user-select: none;\n\t-khtml-user-select: none;\n\t-moz-user-select: none;\n\t-ms-user-select: none;\n\tuser-select: none;\n\tposition: relative;\n\ttouch-action: manipulation;\n\tcursor: default;\n\tfont-size: small;\n}\n.beepboxEditor:focus {\n\toutline: none;\n\tborder-color: #555;\n}\n\n.beepboxEditor div {\n\tmargin: 0;\n\tpadding: 0;\n}\n\n.beepboxEditor .promptContainer {\n\tposition: absolute;\n\ttop: 0;\n\tleft: 0;\n\twidth: 100%;\n\theight: 100%;\n\tbackground: rgba(0,0,0,0.5);\n\tdisplay: flex;\n\tjustify-content: center;\n\talign-items: center;\n}\n\n.beepboxEditor .prompt {\n\tmargin: auto;\n\ttext-align: center;\n\tbackground: #000;\n\tborder-radius: 15px;\n\tborder: 4px solid #444;\n\tcolor: #fff;\n\tpadding: 20px;\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .prompt > *:not(:first-child) {\n\tmargin-top: 1.5em;\n}\n\n/* Use psuedo-elements to add cross-browser up & down arrows to select elements: */\n.beepboxEditor .selectContainer {\n\tposition: relative;\n}\n.beepboxEditor .selectContainer::before {\n\tcontent: "";\n\tposition: absolute;\n\tright: 0.5em;\n\ttop: 0.4em;\n\tborder-bottom: 0.4em solid currentColor;\n\tborder-left: 0.3em solid transparent;\n\tborder-right: 0.3em solid transparent;\n\tpointer-events: none;\n}\n.beepboxEditor .selectContainer::after {\n\tcontent: "";\n\tposition: absolute;\n\tright: 0.5em;\n\tbottom: 0.4em;\n\tborder-top: 0.4em solid currentColor;\n\tborder-left: 0.3em solid transparent;\n\tborder-right: 0.3em solid transparent;\n\tpointer-events: none;\n}\n.beepboxEditor select {\n\tmargin: 0;\n\tpadding: 0 0.5em;\n\tdisplay: block;\n\theight: 2em;\n\tborder: none;\n\tborder-radius: 0.4em;\n\tbackground: #444444;\n\tcolor: inherit;\n\tfont-size: inherit;\n\tcursor: pointer;\n\n\t-webkit-appearance:none;\n\t-moz-appearance: none;\n\tappearance: none;\n}\n.beepboxEditor select:focus {\n\tbackground: #777777;\n\toutline: none;\n}\n/* This makes it look better in firefox on my computer... What about others?\n@-moz-document url-prefix() {\n\t.beepboxEditor select { padding: 0 2px; }\n}\n*/\n.beepboxEditor button {\n\tmargin: 0;\n\tposition: relative;\n\theight: 2em;\n\tborder: none;\n\tborder-radius: 0.4em;\n\tbackground: #444;\n\tcolor: inherit;\n\tfont-size: inherit;\n\tcursor: pointer;\n}\n.beepboxEditor button:focus {\n\tbackground: #777;\n\toutline: none;\n}\n.beepboxEditor button.playButton::before {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\tmargin-left: -0.45em;\n\tmargin-top: -0.65em;\n\tborder-left: 1em solid currentColor;\n\tborder-top: 0.65em solid transparent;\n\tborder-bottom: 0.65em solid transparent;\n\tpointer-events: none;\n}\n.beepboxEditor button.pauseButton::before {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\tmargin-left: -0.5em;\n\tmargin-top: -0.65em;\n\twidth: 0.3em;\n\theight: 1.3em;\n\tbackground: currentColor;\n\tpointer-events: none;\n}\n.beepboxEditor button.pauseButton::after {\n\tcontent: "";\n\tposition: absolute;\n\tleft: 50%;\n\ttop: 50%;\n\tmargin-left: 0.2em;\n\tmargin-top: -0.65em;\n\twidth: 0.3em;\n\theight: 1.3em;\n\tbackground: currentColor;\n\tpointer-events: none;\n}\n\n.beepboxEditor canvas {\n\toverflow: hidden;\n\tposition: absolute;\n\tdisplay: block;\n}\n\n.beepboxEditor .selectRow {\n\tmargin: 0;\n\theight: 2.5em;\n\tdisplay: flex;\n\tflex-direction: row;\n\talign-items: center;\n\tjustify-content: space-between;\n}\n\n.beepboxEditor .selectRow > span {\n\tcolor: #999;\n}\n\n.beepboxEditor .editor-right-side {\n\tmargin-left: 6px;\n\twidth: 182px;\n\theight: 645px;\n\tdisplay: flex;\n\tflex-direction: column;\n}\n\n.beepboxEditor .editor-right-side > * {\n\tflex-shrink: 0;\n}\n\n.beepboxEditor input[type=text], .beepboxEditor input[type=number] {\n\tfont-size: inherit;\n\tbackground: transparent;\n\tborder: 1px solid #777;\n\tcolor: white;\n}\n\n.beepboxEditor input[type=checkbox] {\n  transform: scale(1.5);\n}\n\n.beepboxEditor input[type=range] {\n\t-webkit-appearance: none;\n\tcolor: inherit;\n\twidth: 100%;\n\theight: 2em;\n\tfont-size: inherit;\n\tmargin: 0;\n\tcursor: pointer;\n\tbackground-color: black;\n}\n.beepboxEditor input[type=range]:focus {\n\toutline: none;\n}\n.beepboxEditor input[type=range]::-webkit-slider-runnable-track {\n\twidth: 100%;\n\theight: 0.5em;\n\tcursor: pointer;\n\tbackground: #444;\n}\n.beepboxEditor input[type=range]::-webkit-slider-thumb {\n\theight: 2em;\n\twidth: 0.5em;\n\tborder-radius: 0.25em;\n\tbackground: currentColor;\n\tcursor: pointer;\n\t-webkit-appearance: none;\n\tmargin-top: -0.75em;\n}\n.beepboxEditor input[type=range]:focus::-webkit-slider-runnable-track {\n\tbackground: #777;\n}\n.beepboxEditor input[type=range]::-moz-range-track {\n\twidth: 100%;\n\theight: 0.5em;\n\tcursor: pointer;\n\tbackground: #444;\n}\n.beepboxEditor input[type=range]:focus::-moz-range-track {\n\tbackground: #777;\n}\n.beepboxEditor input[type=range]::-moz-range-thumb {\n\theight: 2em;\n\twidth: 0.5em;\n\tborder-radius: 0.25em;\n\tborder: none;\n\tbackground: currentColor;\n\tcursor: pointer;\n}\n.beepboxEditor input[type=range]::-ms-track {\n\twidth: 100%;\n\theight: 0.5em;\n\tcursor: pointer;\n\tbackground: #444;\n\tborder-color: transparent;\n}\n.beepboxEditor input[type=range]:focus::-ms-track {\n\tbackground: #777;\n}\n.beepboxEditor input[type=range]::-ms-thumb {\n\theight: 2em;\n\twidth: 0.5em;\n\tborder-radius: 0.25em;\n\tbackground: currentColor;\n\tcursor: pointer;\n}\n\n')),document.head.appendChild(i)}(beepbox||(beepbox={})),function(t){function i(t){return t.toFixed(2).replace(/\.?0*$/,"")}var s=function(){return function(){this.valid=!1,this.prevNote=null,this.curNote=null,this.nextNote=null,this.pitch=0,this.pitchIndex=-1,this.curIndex=0,this.start=0,this.end=0,this.part=0,this.notePart=0,this.nearPinIndex=0,this.pins=[]}}(),h=function(){function h(h){var n=this;this.Zt=h,this.Rt=t.svgElement("pattern",{id:"patternEditorNoteBackground",x:"0",y:"0",width:"64",height:"156",patternUnits:"userSpaceOnUse"}),this.It=t.svgElement("pattern",{id:"patternEditorDrumBackground",x:"0",y:"0",width:"64",height:"40",patternUnits:"userSpaceOnUse"}),this.Gt=t.svgElement("rect",{x:"0",y:"0",width:"512",height:"481","pointer-events":"none",fill:"url(#patternEditorNoteBackground)"}),this.Bt=t.svgElement("svg"),this.St=t.svgElement("rect",{id:"",x:"0",y:"0",width:"4",height:"481",fill:"white","pointer-events":"none"}),this.Ct=t.svgElement("path",{fill:"none",stroke:"white","stroke-width":"2","pointer-events":"none"}),this.jt=t.svgElement("svg",{style:"background-color: #000000; touch-action: none; position: absolute;",width:"512",height:"481"},[t.svgElement("defs",void 0,[this.Rt,this.It]),this.Gt,this.Bt,this.Ct,this.St]),this.container=t.html.div({style:"height: 481px; overflow:hidden; position: relative;"},[this.jt]),this.Dt=13,this.Ut=40,this.Yt=[],this.zt=t.svgElement("rect"),this.Lt=[[t.makeNotePin(0,0,3),t.makeNotePin(0,2,3)],[t.makeNotePin(0,0,3),t.makeNotePin(0,2,3)],[t.makeNotePin(0,0,3),t.makeNotePin(0,2,3)],[t.makeNotePin(0,0,3),t.makeNotePin(0,2,0)]],this.Vt=481,this.Ft=0,this.Wt=0,this.Jt=!1,this.Tt=!1,this.Ot=!1,this.Pt=!1,this.Qt=this.Lt.concat(),this.Xt=0,this.Ht=0,this.Kt=0,this._t=0,this.qt=null,this.$t=new s,this.ti=null,this.ii=0,this.si=0,this.hi=-1,this.ni=-1,this.ei=!1,this.ri=!1,this.resetCopiedPins=function(){n.Qt=n.Lt.concat()},this.oi=function(t){if(n.Zt.synth.playing&&null!=n.ti&&n.Zt.song.getPattern(n.Zt.channel,Math.floor(n.Zt.synth.playhead))==n.ti){n.St.setAttribute("visibility","visible");var s=n.Zt.synth.playhead-Math.floor(n.Zt.synth.playhead);Math.abs(s-n.ii)>.1?n.ii=s:n.ii+=.2*(s-n.ii),n.St.setAttribute("x",""+i(n.ii*n.ai-2))}else n.St.setAttribute("visibility","hidden");window.requestAnimationFrame(n.oi)},this.ui=function(t){n.Tt||(n.Tt=!0)},this.li=function(t){n.Tt&&(n.Tt=!1)},this.ci=function(t){if(t.preventDefault(),null!=n.ti){var i=n.jt.getBoundingClientRect();n.Ft=(t.clientX||t.pageX)-i.left,n.Wt=(t.clientY||t.pageY)-i.top,n.fi()}},this.vi=function(t){if(t.preventDefault(),null!=n.ti){var i=n.jt.getBoundingClientRect();n.Ft=t.touches[0].clientX-i.left,n.Wt=t.touches[0].clientY-i.top,n.fi()}},this.di=function(t){var i=n.jt.getBoundingClientRect();n.Ft=(t.clientX||t.pageX)-i.left,n.Wt=(t.clientY||t.pageY)-i.top,n.bi()},this.wi=function(t){if(n.Jt){t.preventDefault();var i=n.jt.getBoundingClientRect();n.Ft=t.touches[0].clientX-i.left,n.Wt=t.touches[0].clientY-i.top,n.bi()}},this.pi=function(i){if(n.$t.valid&&null!=n.ti){var s=n.Zt.history.lastChangeWas(n.qt);if(n.Ot&&s)null!=n.qt&&(n.Zt.history.record(n.qt),n.qt=null);else if(n.Jt&&s)if(null==n.$t.curNote){var h=t.makeNote(n.$t.pitch,n.$t.start,n.$t.end,3,3==n.Zt.channel);h.pins=[];for(var e=0,r=n.$t.pins;e<r.length;e++){var o=r[e];h.pins.push(t.makeNotePin(0,o.time,o.volume))}n.Zt.history.record(new t.ChangeNoteAdded(n.Zt,n.ti,h,n.$t.curIndex))}else if(-1==n.$t.pitchIndex){var a=new t.ChangeSequence;4==n.$t.curNote.pitches.length&&a.append(new t.ChangePitchAdded(n.Zt,n.ti,n.$t.curNote,n.$t.curNote.pitches[0],0,!0)),a.append(new t.ChangePitchAdded(n.Zt,n.ti,n.$t.curNote,n.$t.pitch,n.$t.curNote.pitches.length)),n.Zt.history.record(a),n.mi(n.$t.curNote)}else 1==n.$t.curNote.pitches.length?n.Zt.history.record(new t.ChangeNoteAdded(n.Zt,n.ti,n.$t.curNote,n.$t.curIndex,!0)):n.Zt.history.record(new t.ChangePitchAdded(n.Zt,n.ti,n.$t.curNote,n.$t.pitch,n.$t.curNote.pitches.indexOf(n.$t.pitch),!0));n.Jt=!1,n.Ot=!1,n.gi(),n.Mi()}},this.yi=function(){n.ai=n.Zt.showLetters?n.Zt.showScrollBar?460:480:n.Zt.showScrollBar?492:512,n.ti=n.Zt.getCurrentPattern(),n.xi=n.ai/(n.Zt.song.beats*n.Zt.song.parts),n.Ai=3==n.Zt.channel?n.Ut:n.Dt,n.ki=3==n.Zt.channel?t.Music.drumCount:t.Music.pitchCount,n.si=12*n.Zt.song.channelOctaves[n.Zt.channel],n.Ni=n.Qt[n.Zt.channel],n.hi!=n.ai&&(n.hi=n.ai,n.jt.setAttribute("width",""+n.ai),n.Gt.setAttribute("width",""+n.ai));var i,s,h=n.ai/n.Zt.song.beats;if(n.ni!=h){n.ni=h,n.Rt.setAttribute("width",""+h),n.It.setAttribute("width",""+h),n.zt.setAttribute("width",""+(h-2));for(var e=0;e<12;e++)n.Yt[e].setAttribute("width",""+(h-2))}if(n.Jt||n.gi(),n.Bt=(i=n.Bt,s=i.cloneNode(!1),i.parentNode.replaceChild(s,i),s),n.Mi(),null!=n.ti){n.jt.style.visibility="visible",n.ei!=n.Zt.showFifth&&(n.ei=n.Zt.showFifth,n.Yt[7].setAttribute("fill",n.Zt.showFifth?"#446688":"#444444"));for(e=0;e<12;e++)n.Yt[e].style.visibility=t.Music.scaleFlags[n.Zt.song.scale][e]?"visible":"hidden";if(3==n.Zt.channel?n.ri||(n.ri=!0,n.Gt.setAttribute("fill","url(#patternEditorDrumBackground)"),n.Gt.setAttribute("height",""+n.Ut*t.Music.drumCount),n.jt.setAttribute("height",""+n.Ut*t.Music.drumCount)):n.ri&&(n.ri=!1,n.Gt.setAttribute("fill","url(#patternEditorNoteBackground)"),n.Gt.setAttribute("height",""+n.Vt),n.jt.setAttribute("height",""+n.Vt)),3!=n.Zt.channel&&n.Zt.showChannels)for(var r=2;r>=0;r--)if(r!=n.Zt.channel){var o=n.Zt.song.getPattern(r,n.Zt.bar);if(null!=o)for(var a=0,u=o.notes;a<u.length;a++)for(var l=0,c=(b=u[a]).pitches;l<c.length;l++){var f=c[l];(m=t.svgElement("path")).setAttribute("fill",t.SongEditor.noteColorsDim[r]),m.setAttribute("pointer-events","none"),n.Ei(m,f,b.start,b.pins,n.Ai/2-4,!1,12*n.Zt.song.channelOctaves[r]),n.Bt.appendChild(m)}}for(var v=0,d=n.ti.notes;v<d.length;v++)for(var b,w=0,p=(b=d[v]).pitches;w<p.length;w++){var m;f=p[w];(m=t.svgElement("path")).setAttribute("fill",t.SongEditor.noteColorsDim[n.Zt.channel]),m.setAttribute("pointer-events","none"),n.Ei(m,f,b.start,b.pins,n.Ai/2+1,!1,n.si),n.Bt.appendChild(m),(m=t.svgElement("path")).setAttribute("fill",t.SongEditor.noteColorsBright[n.Zt.channel]),m.setAttribute("pointer-events","none"),n.Ei(m,f,b.start,b.pins,n.Ai/2+1,!0,n.si),n.Bt.appendChild(m)}}else n.jt.style.visibility="hidden"};for(var e=0;e<12;e++){var r=(12-e)%12,o=t.svgElement("rect");o.setAttribute("x","1"),o.setAttribute("y",""+(r*this.Dt+1)),o.setAttribute("height",""+(this.Dt-2)),o.setAttribute("fill",0==e?"#886644":"#444444"),this.Rt.appendChild(o),this.Yt[e]=o}this.zt.setAttribute("x","1"),this.zt.setAttribute("y","1"),this.zt.setAttribute("height",""+(this.Ut-2)),this.zt.setAttribute("fill","#444444"),this.It.appendChild(this.zt),this.Zt.notifier.watch(this.yi),this.yi(),this.gi(),this.Mi(),window.requestAnimationFrame(this.oi),this.jt.addEventListener("mousedown",this.ci),document.addEventListener("mousemove",this.di),document.addEventListener("mouseup",this.pi),this.jt.addEventListener("mouseover",this.ui),this.jt.addEventListener("mouseout",this.li),this.jt.addEventListener("touchstart",this.vi),document.addEventListener("touchmove",this.wi),document.addEventListener("touchend",this.pi),document.addEventListener("touchcancel",this.pi)}return h.prototype.gi=function(){if(null!=this.ti&&(this.$t=new s,!(this.Ft<0||this.Ft>this.ai||this.Wt<0||this.Wt>this.Vt))){this.$t.part=Math.floor(Math.max(0,Math.min(this.Zt.song.beats*this.Zt.song.parts-1,this.Ft/this.xi)));for(var i=0,h=this.ti.notes;i<h.length;i++){var n=h[i];if(n.end<=this.$t.part)this.$t.prevNote=n,this.$t.curIndex++;else if(n.start<=this.$t.part&&n.end>this.$t.part)this.$t.curNote=n;else if(n.start>this.$t.part){this.$t.nextNote=n;break}}var e=this.Zi(this.Wt);if(null!=this.$t.curNote){this.$t.start=this.$t.curNote.start,this.$t.end=this.$t.curNote.end,this.$t.pins=this.$t.curNote.pins;for(var r=0,o=0,a=void 0,u=this.$t.curNote.pins[0],l=1;l<this.$t.curNote.pins.length;l++){a=u,u=this.$t.curNote.pins[l];var c=this.xi*(this.$t.curNote.start+a.time),f=this.xi*(this.$t.curNote.start+u.time);if(!(this.Ft>f)){if(this.Ft<c)throw new Error;var v=(this.Ft-c)/(f-c),d=Math.sqrt(1/Math.sqrt(4)-Math.pow(v-.5,2))-.5,b=Math.abs(u.interval-a.interval);r=a.interval*(1-v)+u.interval*v,o=d*b+1;break}}for(var w=Number.MAX_VALUE,p=-Number.MAX_VALUE,m=Number.MAX_VALUE,g=0,M=this.$t.curNote.pins;g<M.length;g++){var y=M[g];w>y.interval&&(w=y.interval),p<y.interval&&(p=y.interval);var x=Math.abs(this.$t.curNote.start+y.time-this.Ft/this.xi);m>x&&(m=x,this.$t.nearPinIndex=this.$t.curNote.pins.indexOf(y))}if(e-=r,this.$t.pitch=this.Ri(e,-w,(3==this.Zt.channel?t.Music.drumCount-1:t.Music.maxPitch)-p),3!=this.Zt.channel)for(var A=o,k=0;k<this.$t.curNote.pitches.length;k++){var N=Math.abs(this.$t.curNote.pitches[k]-e+.5);N>A||(A=N,this.$t.pitch=this.$t.curNote.pitches[k])}for(k=0;k<this.$t.curNote.pitches.length;k++)if(this.$t.curNote.pitches[k]==this.$t.pitch){this.$t.pitchIndex=k;break}}else{this.$t.pitch=this.Ri(e,0,t.Music.maxPitch);var E=this.Ni[this.Ni.length-1].time,Z=Math.floor(this.$t.part/this.Zt.song.parts),R=E%this.Zt.song.parts,I=this.$t.part%this.Zt.song.parts;1==E?this.$t.start=this.$t.part:0==R?(this.$t.start=Z*this.Zt.song.parts,this.Zt.song.parts>>1==this.Zt.song.parts/2&&I>this.Zt.song.parts/2&&E==this.Zt.song.parts&&(this.$t.start+=this.Zt.song.parts/2)):(this.$t.start=Z*this.Zt.song.parts,R==this.Zt.song.parts/2?I>=this.Zt.song.parts/2&&(this.$t.start+=this.Zt.song.parts-R):I>this.Zt.song.parts/2&&(this.$t.start+=this.Zt.song.parts-R)),this.$t.end=this.$t.start+E;var G=0,B=this.Zt.song.beats*this.Zt.song.parts;if(null!=this.$t.prevNote&&(G=this.$t.prevNote.end),null!=this.$t.nextNote&&(B=this.$t.nextNote.start),this.$t.start<G?(this.$t.start=G,this.$t.end=this.$t.start+E,this.$t.end>B&&(this.$t.end=B)):this.$t.end>B&&(this.$t.end=B,this.$t.start=this.$t.end-E,this.$t.start<G&&(this.$t.start=G)),this.$t.end-this.$t.start==E)this.$t.pins=this.Ni;else{this.$t.pins=[];for(var S=0,C=this.Ni;S<C.length;S++){var j=C[S];if(!(j.time<=this.$t.end-this.$t.start)){this.$t.pins.push(t.makeNotePin(0,this.$t.end-this.$t.start,j.volume));break}if(this.$t.pins.push(t.makeNotePin(0,j.time,j.volume)),j.time==this.$t.end-this.$t.start)break}}}this.$t.valid=!0}},h.prototype.Zi=function(t){return Math.max(0,Math.min(this.ki-1,this.ki-t/this.Ai))+this.si},h.prototype.Ri=function(i,s,h){i<s&&(i=s),i>h&&(i=h);var n=t.Music.scaleFlags[this.Zt.song.scale];if(n[Math.floor(i)%12]||3==this.Zt.channel)return Math.floor(i);for(var e=Math.floor(i)+1,r=Math.floor(i)-1;!n[e%12];)e++;for(;!n[r%12];)r--;if(e>h)return r<s?s:r;if(r<s)return e;var o=e,a=r+1;return e%12!=0&&e%12!=7||(o-=.5),r%12!=0&&r%12!=7||(a+=.5),i-a>o-i?e:r},h.prototype.mi=function(i){this.Ni=[];for(var s=0,h=i.pins;s<h.length;s++){var n=h[s];this.Ni.push(t.makeNotePin(0,n.time,n.volume))}for(var e=1;e<this.Ni.length-1;)this.Ni[e-1].volume==this.Ni[e].volume&&this.Ni[e].volume==this.Ni[e+1].volume?this.Ni.splice(e,1):e++;this.Qt[this.Zt.channel]=this.Ni},h.prototype.fi=function(){this.Jt=!0,this.Xt=this.Ft,this.Ht=this.Wt,this.Kt=this.Ft,this._t=this.Wt,this.gi(),this.Mi(),this.qt=new t.ChangeSequence,this.Zt.history.setProspectiveChange(this.qt)},h.prototype.bi=function(){var i,s;if(null!=this.ti){var h=this.Zt.history.lastChangeWas(this.qt);if(this.Jt&&this.$t.valid&&h){if(!this.Ot){var n=this.Ft-this.Xt,e=this.Wt-this.Ht;Math.sqrt(n*n+e*e)>5&&(this.Ot=!0,this.Pt=Math.abs(n)>=Math.abs(e))}if(this.Ot){null!=this.qt&&this.qt.undo();var r=Math.floor(this.Ft/this.xi),o=new t.ChangeSequence;if(this.qt=o,this.Zt.history.setProspectiveChange(this.qt),null==this.$t.curNote){var a=void 0,u=void 0;r<this.$t.start?(a=!0,u=this.$t.start-r):(a=!1,u=r-this.$t.start+1);for(var l=1,c=0;c<=this.Zt.song.beats*this.Zt.song.parts;c++)if(!(c>=5&&c%this.Zt.song.parts!=0&&c!=3*this.Zt.song.parts/2&&c!=4*this.Zt.song.parts/3&&c!=5*this.Zt.song.parts/3)){if(c==u){l=c;break}if(c<u&&(l=c),c>u){l<u-1&&(l=c);break}}a?i=(s=this.$t.start)-l:s=(i=this.$t.start)+l,i<0&&(i=0),s>this.Zt.song.beats*this.Zt.song.parts&&(s=this.Zt.song.beats*this.Zt.song.parts),o.append(new t.ChangeNoteTruncate(this.Zt,this.ti,i,s));var f=void 0;for(f=0;f<this.ti.notes.length&&!(this.ti.notes[f].start>=s);f++);var v=t.makeNote(this.$t.pitch,i,s,3,3==this.Zt.channel);o.append(new t.ChangeNoteAdded(this.Zt,this.ti,v,f)),this.mi(v)}else if(this.Pt){var d=Math.round((this.Ft-this.Xt)/this.xi),b=this.$t.curNote.pins[this.$t.nearPinIndex],w=this.$t.curNote.start+b.time+d;w<0&&(w=0),w>this.Zt.song.beats*this.Zt.song.parts&&(w=this.Zt.song.beats*this.Zt.song.parts),w<=this.$t.curNote.start&&this.$t.nearPinIndex==this.$t.curNote.pins.length-1||w>=this.$t.curNote.end&&0==this.$t.nearPinIndex?o.append(new t.ChangeNoteAdded(this.Zt,this.ti,this.$t.curNote,this.$t.curIndex,!0)):(i=Math.min(this.$t.curNote.start,w),s=Math.max(this.$t.curNote.end,w),o.append(new t.ChangeNoteTruncate(this.Zt,this.ti,i,s,this.$t.curNote)),o.append(new t.ChangePinTime(this.Zt,this.$t.curNote,this.$t.nearPinIndex,w)),this.mi(this.$t.curNote))}else if(-1==this.$t.pitchIndex){var p=Math.round(Math.max(this.$t.curNote.start,Math.min(this.$t.curNote.end,this.Ft/this.xi)))-this.$t.curNote.start,m=void 0,g=this.$t.curNote.pins[0],M=0,y=0;for(f=1;f<this.$t.curNote.pins.length;f++)if(m=g,!(p>(g=this.$t.curNote.pins[f]).time)){if(p<m.time)throw new Error;var x=(p-m.time)/(g.time-m.time);(M=Math.round(m.volume*(1-x)+g.volume*x+(this.Ht-this.Wt)/25))<0&&(M=0),M>3&&(M=3),y=this.Ri(m.interval*(1-x)+g.interval*x+this.$t.curNote.pitches[0],0,t.Music.maxPitch)-this.$t.curNote.pitches[0];break}o.append(new t.ChangeVolumeBend(this.Zt,this.ti,this.$t.curNote,p,M,y)),this.mi(this.$t.curNote)}else{var A=void 0,k=void 0;this.Ft>=this.Xt?(A=this.$t.part,k=r+1):(A=this.$t.part+1,k=r),k<0&&(k=0),k>this.Zt.song.beats*this.Zt.song.parts&&(k=this.Zt.song.beats*this.Zt.song.parts),k>this.$t.curNote.end&&o.append(new t.ChangeNoteTruncate(this.Zt,this.ti,this.$t.curNote.start,k,this.$t.curNote)),k<this.$t.curNote.start&&o.append(new t.ChangeNoteTruncate(this.Zt,this.ti,k,this.$t.curNote.end,this.$t.curNote));for(var N=Number.MAX_VALUE,E=-Number.MAX_VALUE,Z=0,R=this.$t.curNote.pitches;Z<R.length;Z++){var I=R[Z];N>I&&(N=I),E<I&&(E=I)}N-=this.$t.curNote.pitches[0],E-=this.$t.curNote.pitches[0];var G=this.Ri(this.Zi(this.Wt),-N,t.Music.maxPitch-E);o.append(new t.ChangePitchBend(this.Zt,this.$t.curNote,A,k,G,this.$t.pitchIndex)),this.mi(this.$t.curNote)}}this.Kt=this.Ft,this._t=this.Wt}else this.gi(),this.Mi()}},h.prototype.Mi=function(){this.Tt&&!this.Jt&&this.$t.valid&&null!=this.ti?(this.Ct.setAttribute("visibility","visible"),this.Ei(this.Ct,this.$t.pitch,this.$t.start,this.$t.pins,this.Ai/2+1,!0,this.si)):this.Ct.setAttribute("visibility","hidden")},h.prototype.Ei=function(t,s,h,n,e,r,o){for(var a=n[0],u="M "+i(this.xi*(h+a.time)+1)+" "+i(this.Ii(s-o)+e*(r?a.volume/3:1))+" ",l=1;l<n.length;l++){var c=a;a=n[l];var f=this.xi*(h+c.time)+(1==l?1:0),v=this.xi*(h+a.time)-(l==n.length-1?1:0),d=this.Ii(s+c.interval-o),b=this.Ii(s+a.interval-o),w=r?c.volume/3:1,p=r?a.volume/3:1;u+="L "+i(f)+" "+i(d-e*w)+" ",c.interval>a.interval&&(u+="L "+i(f+1)+" "+i(d-e*w)+" "),c.interval<a.interval&&(u+="L "+i(v-1)+" "+i(b-e*p)+" "),u+="L "+i(v)+" "+i(b-e*p)+" "}for(l=n.length-2;l>=0;l--){c=a;a=n[l];f=this.xi*(h+c.time)-(l==n.length-2?1:0),v=this.xi*(h+a.time)+(0==l?1:0),d=this.Ii(s+c.interval-o),b=this.Ii(s+a.interval-o),w=r?c.volume/3:1,p=r?a.volume/3:1;u+="L "+i(f)+" "+i(d+e*w)+" ",c.interval<a.interval&&(u+="L "+i(f-1)+" "+i(d+e*w)+" "),c.interval>a.interval&&(u+="L "+i(v+1)+" "+i(b+e*p)+" "),u+="L "+i(v)+" "+i(b+e*p)+" "}u+="z",t.setAttribute("d",u)},h.prototype.Ii=function(t){return this.Ai*(this.ki-t-.5)},h}();t.PatternEditor=h}(beepbox||(beepbox={})),function(t){var i=function(){function i(i,s,h){this.Gi=t.html.text("1"),this.Bi=t.svgElement("text",{x:16,y:23,"font-family":"sans-serif","font-size":20,"text-anchor":"middle","font-weight":"bold",fill:"red"},[this.Gi]),this.Si=t.svgElement("rect",{width:30,height:30,x:1,y:1}),this.container=t.svgElement("svg",void 0,[this.Si,this.Bi]),this.Ci=1,this.ji=!0,this.Di=!1,this.container.setAttribute("x",""+32*s),this.container.setAttribute("y",""+32*h),this.Si.setAttribute("fill","#444444"),this.Bi.setAttribute("fill",t.SongEditor.channelColorsDim[h])}return i.prototype.setSquashed=function(t,i){t?(this.container.setAttribute("y",""+27*i),this.Si.setAttribute("height","25"),this.Bi.setAttribute("y","21")):(this.container.setAttribute("y",""+32*i),this.Si.setAttribute("height","30"),this.Bi.setAttribute("y","23"))},i.prototype.setIndex=function(i,s,h,n){this.Ci!=i&&(this.Di||0==i==(0==this.Ci)||this.Si.setAttribute("fill",0==i?"#000000":"#444444"),this.Ci=i,this.Gi.data=""+i),this.ji!=s&&(this.ji=s,h?this.Bi.setAttribute("fill","#000000"):this.Bi.setAttribute("fill",s?t.SongEditor.channelColorsDim[n]:t.SongEditor.channelColorsBright[n])),this.Di!=h&&(this.Di=h,h?(this.Si.setAttribute("fill",t.SongEditor.channelColorsBright[n]),this.Bi.setAttribute("fill","#000000")):(this.Si.setAttribute("fill",0==this.Ci?"#000000":"#444444"),this.Bi.setAttribute("fill",s?t.SongEditor.channelColorsDim[n]:t.SongEditor.channelColorsBright[n])))},i}(),s=function(){function s(s,h){var n=this;this.Zt=s,this.Ui=h,this.ai=512,this.Yi=32,this.jt=t.svgElement("svg",{style:"background-color: #000000; position: absolute;",width:this.ai,height:128}),this.container=t.html.div({style:"width: 512px; height: 128px; position: relative; overflow:hidden;"},[this.jt]),this.Z=t.svgElement("rect",{fill:"white",x:0,y:0,width:4,height:128}),this.zi=t.svgElement("rect",{fill:"none",stroke:"white","stroke-width":2,"pointer-events":"none",x:1,y:1,width:30,height:30}),this.Li=t.svgElement("path",{fill:"black",stroke:"black","stroke-width":1,"pointer-events":"none"}),this.Vi=t.svgElement("path",{fill:"black",stroke:"black","stroke-width":1,"pointer-events":"none"}),this.Fi=[[],[],[],[]],this.Ft=0,this.Wt=0,this.ti=null,this.Tt=!1,this.Wi="",this.Vt=128,this.Ji=32,this.Ti=!1,this.Oi=-1,this.Pi=null,this.oi=function(t){var i=n.Yi*(n.Zt.synth.playhead-n.Zt.barScrollPos)-2;n.Oi!=i&&(n.Oi=i,n.Z.setAttribute("x",""+i)),window.requestAnimationFrame(n.oi)},this.ui=function(t){n.Tt||(n.Tt=!0)},this.li=function(t){n.Tt&&(n.Tt=!1)},this.ci=function(i){i.preventDefault();var s=n.jt.getBoundingClientRect();n.Ft=(i.clientX||i.pageX)-s.left,n.Wt=(i.clientY||i.pageY)-s.top;var h=Math.floor(Math.min(t.Music.numChannels-1,Math.max(0,n.Wt/n.Ji))),e=Math.floor(Math.min(n.Zt.song.bars-1,Math.max(0,n.Ft/n.Yi+n.Zt.barScrollPos)));if(n.Zt.channel==h&&n.Zt.bar==e){var r=n.Wt%n.Ji<n.Ji/2,o=n.Zt.song.channelPatterns[h].length;n.Qi((n.Zt.song.channelBars[h][e]+(r?1:o))%(o+1))}else n.Xi(h,e)},this.di=function(t){var i=n.jt.getBoundingClientRect();n.Ft=(t.clientX||t.pageX)-i.left,n.Wt=(t.clientY||t.pageY)-i.top,n.Mi()},this.Hi=function(t){},this.yi=function(){n.ti=n.Zt.getCurrentPattern();var i=n.Zt.song.bars>16?108:128;n.Vt!=i&&(n.Vt=n.Zt.song.bars>16?108:128,n.jt.setAttribute("height",""+n.Vt),n.container.style.height=""+n.Vt,n.Ji=n.Vt/t.Music.numChannels),n.Ki()},this.ti=this.Zt.getCurrentPattern();for(var e=0;e<t.Music.numChannels;e++)for(var r=0;r<16;r++){var o=new i(e,r,e);this.jt.appendChild(o.container),this.Fi[e][r]=o}this.jt.appendChild(this.zi),this.jt.appendChild(this.Li),this.jt.appendChild(this.Vi),this.jt.appendChild(this.Z),this.Ki(),this.Zt.notifier.watch(this.yi),window.requestAnimationFrame(this.oi),this.container.addEventListener("mousedown",this.ci),document.addEventListener("mousemove",this.di),document.addEventListener("mouseup",this.Hi),this.container.addEventListener("mouseover",this.ui),this.container.addEventListener("mouseout",this.li)}return s.prototype.Xi=function(i,s){new t.ChangeChannelBar(this.Zt,i,s),this.Wi="",this.Zt.history.forgetLastChange()},s.prototype.Qi=function(i){var s=this.Zt.song.channelBars[this.Zt.channel][this.Zt.bar],h=this.Zt.history.lastChangeWas(this.Pi),n=h?this.Pi.oldValue:s;i!=s&&(this.Pi=new t.ChangeBarPattern(this.Zt,n,i),this.Zt.history.record(this.Pi,h))},s.prototype.onKeyPressed=function(i){switch(i.keyCode){case 38:this.Xi((this.Zt.channel+3)%t.Music.numChannels,this.Zt.bar),i.preventDefault();break;case 40:this.Xi((this.Zt.channel+1)%t.Music.numChannels,this.Zt.bar),i.preventDefault();break;case 37:this.Xi(this.Zt.channel,(this.Zt.bar+this.Zt.song.bars-1)%this.Zt.song.bars),i.preventDefault();break;case 39:this.Xi(this.Zt.channel,(this.Zt.bar+1)%this.Zt.song.bars),i.preventDefault();break;case 48:this._i("0"),i.preventDefault();break;case 49:this._i("1"),i.preventDefault();break;case 50:this._i("2"),i.preventDefault();break;case 51:this._i("3"),i.preventDefault();break;case 52:this._i("4"),i.preventDefault();break;case 53:this._i("5"),i.preventDefault();break;case 54:this._i("6"),i.preventDefault();break;case 55:this._i("7"),i.preventDefault();break;case 56:this._i("8"),i.preventDefault();break;case 57:this._i("9"),i.preventDefault();break;default:this.Wi=""}},s.prototype._i=function(t){this.Wi+=t;var i=parseInt(this.Wi);i<=this.Zt.song.patterns?this.Qi(i):(this.Wi=t,(i=parseInt(this.Wi))<=this.Zt.song.patterns?this.Qi(i):this.Wi="")},s.prototype.Mi=function(){var i=Math.floor(Math.min(t.Music.numChannels-1,Math.max(0,this.Wt/this.Ji))),s=Math.floor(Math.min(this.Zt.song.bars-1,Math.max(0,this.Ft/this.Yi+this.Zt.barScrollPos))),h=s==this.Zt.bar&&i==this.Zt.channel;if(this.Tt&&!h?(this.zi.setAttribute("x",""+(1+this.Yi*(s-this.Zt.barScrollPos))),this.zi.setAttribute("y",""+(1+this.Ji*i)),this.zi.setAttribute("height",""+(this.Ji-2)),this.zi.style.visibility="visible"):this.zi.style.visibility="hidden",this.Tt&&h){var n=this.Wt%this.Ji<this.Ji/2,e=this.Yi*(s-this.Zt.barScrollPos+.8),r=this.Ji*(i+.5),o=.1*this.Ji,a=.4*this.Ji,u=.175*this.Ji;this.Li.setAttribute("fill",n?"#fff":"#000"),this.Vi.setAttribute("fill",n?"#000":"#fff"),this.Li.setAttribute("d","M "+e+" "+(r-a)+" L "+(e+u)+" "+(r-o)+" L "+(e-u)+" "+(r-o)+" z"),this.Vi.setAttribute("d","M "+e+" "+(r+a)+" L "+(e+u)+" "+(r+o)+" L "+(e-u)+" "+(r+o)+" z"),this.Li.style.visibility="visible",this.Vi.style.visibility="visible"}else this.Li.style.visibility="hidden",this.Vi.style.visibility="hidden"},s.prototype.Ki=function(){var i=this.Zt.song.bars>16;if(this.Ti!=i){this.Ti=i;for(var s=0;s<t.Music.numChannels;s++)for(var h=0;h<16;h++)this.Fi[s][h].setSquashed(i,s)}for(var n=0;n<t.Music.numChannels;n++)for(var e=0;e<16;e++){var r=this.Zt.song.getPattern(n,e+this.Zt.barScrollPos),o=e+this.Zt.barScrollPos==this.Zt.bar&&n==this.Zt.channel,a=null==r||0==r.notes.length,u=this.Fi[n][e];e<this.Zt.song.bars?(u.setIndex(this.Zt.song.channelBars[n][e+this.Zt.barScrollPos],a,o,n),u.container.style.visibility="visible"):u.container.style.visibility="hidden"}this.Mi()},s}();t.TrackEditor=s}(beepbox||(beepbox={})),function(t){var i=function(){function i(i){var s=this;this.Zt=i,this.Yi=32,this.ai=512,this.Vt=20,this.qi=0,this.$i=1,this.ts=2,this.ss=t.svgElement("path",{fill:"none",stroke:"#7744ff","stroke-width":4}),this.hs=t.svgElement("path",{fill:"white","pointer-events":"none"}),this.jt=t.svgElement("svg",{style:"background-color: #000000; touch-action: pan-y; position: absolute;",width:this.ai,height:this.Vt},[this.ss,this.hs]),this.ns=t.html.canvas({width:"512",height:"20"}),this.es=t.html.canvas({width:"512",height:"20"}),this.container=t.html.div({style:"width: 512px; height: 20px; position: relative;"},[this.jt]),this.rs=null,this.$t={startBar:-1,mode:-1},this.Ft=0,this.Wt=0,this.Jt=!1,this.Tt=!1,this.os=-1,this.as=-1,this.ui=function(t){s.Tt||(s.Tt=!0,s.Mi())},this.li=function(t){s.Tt&&(s.Tt=!1,s.Mi())},this.ci=function(t){t.preventDefault(),s.Jt=!0;var i=s.jt.getBoundingClientRect();s.Ft=(t.clientX||t.pageX)-i.left,s.Wt=(t.clientY||t.pageY)-i.top,s.gi(),s.Mi(),s.di(t)},this.vi=function(t){t.preventDefault(),s.Jt=!0;var i=s.jt.getBoundingClientRect();s.Ft=t.touches[0].clientX-i.left,s.Wt=t.touches[0].clientY-i.top,s.gi(),s.Mi(),s.wi(t)},this.di=function(t){var i=s.jt.getBoundingClientRect();s.Ft=(t.clientX||t.pageX)-i.left,s.Wt=(t.clientY||t.pageY)-i.top,s.bi()},this.wi=function(t){if(s.Jt){t.preventDefault();var i=s.jt.getBoundingClientRect();s.Ft=t.touches[0].clientX-i.left,s.Wt=t.touches[0].clientY-i.top,s.bi()}},this.pi=function(t){null!=s.rs&&s.Zt.history.record(s.rs),s.rs=null,s.Jt=!1,s.gi(),s.Ki()},this.yi=function(){s.Ki()},this.gi(),this.Ki(),this.Zt.notifier.watch(this.yi),this.container.addEventListener("mousedown",this.ci),document.addEventListener("mousemove",this.di),document.addEventListener("mouseup",this.pi),this.container.addEventListener("mouseover",this.ui),this.container.addEventListener("mouseout",this.li),this.container.addEventListener("touchstart",this.vi),document.addEventListener("touchmove",this.wi),document.addEventListener("touchend",this.pi),document.addEventListener("touchcancel",this.pi)}return i.prototype.gi=function(){var t=this.Ft/this.Yi+this.Zt.barScrollPos;this.$t.startBar=t,t>this.Zt.song.loopStart-.25&&t<this.Zt.song.loopStart+this.Zt.song.loopLength+.25?t-this.Zt.song.loopStart<.5*this.Zt.song.loopLength?this.$t.mode=this.qi:this.$t.mode=this.$i:this.$t.mode=this.ts},i.prototype.us=function(t){var i=Math.round(t-this.Zt.song.loopLength/2),s=i+this.Zt.song.loopLength;return i<0&&(s-=i,i=0),s>this.Zt.song.bars&&(i-=s-this.Zt.song.bars,s=this.Zt.song.bars),{start:i,length:s-i}},i.prototype.bi=function(){if(this.Jt){var i=this.Zt.song.loopStart,s=this.Zt.song.loopStart+this.Zt.song.loopLength;null!=this.rs&&this.Zt.history.lastChangeWas(this.rs)&&(s=(i=this.rs.oldStart)+this.rs.oldLength);var h=this.Ft/this.Yi+this.Zt.barScrollPos,n=void 0,e=void 0,r=void 0;if(this.$t.mode==this.qi)(n=i+Math.round(h-this.$t.startBar))==(e=s)?n=e-1:n>e&&(r=n,n=e,e=r),n<0&&(n=0),e>=this.Zt.song.bars&&(e=this.Zt.song.bars),this.rs=new t.ChangeLoop(this.Zt,i,s-i,n,e-n);else if(this.$t.mode==this.$i)n=i,(e=s+Math.round(h-this.$t.startBar))==n?e=n+1:e<n&&(r=n,n=e,e=r),n<0&&(n=0),e>=this.Zt.song.bars&&(e=this.Zt.song.bars),this.rs=new t.ChangeLoop(this.Zt,i,s-i,n,e-n);else if(this.$t.mode==this.ts){var o=this.us(h);this.rs=new t.ChangeLoop(this.Zt,i,s-i,o.start,o.length)}this.Zt.history.setProspectiveChange(this.rs)}else this.gi(),this.Mi()},i.prototype.Mi=function(){var t=this.Tt&&!this.Jt;if(this.hs.style.visibility=t?"visible":"hidden",t){var i=this.Vt/2,s=(this.Zt.song.loopStart-this.Zt.barScrollPos)*this.Yi,h=(this.Zt.song.loopStart+this.Zt.song.loopLength-this.Zt.barScrollPos)*this.Yi;if(this.$t.mode==this.qi)h=(this.Zt.song.loopStart-this.Zt.barScrollPos)*this.Yi+2*i;else if(this.$t.mode==this.$i)s=(this.Zt.song.loopStart+this.Zt.song.loopLength-this.Zt.barScrollPos)*this.Yi-2*i;else{var n=this.us(this.$t.startBar);s=(n.start-this.Zt.barScrollPos)*this.Yi,h=(n.start+n.length-this.Zt.barScrollPos)*this.Yi}this.hs.setAttribute("d","M "+(s+i)+" 4 L "+(h-i)+" 4 A "+(i-4)+" "+(i-4)+" 0 0 1 "+(h-i)+" "+(this.Vt-4)+" L "+(s+i)+" "+(this.Vt-4)+" A "+(i-4)+" "+(i-4)+" 0 0 1 "+(s+i)+" 4 z")}},i.prototype.Ki=function(){var t=this.Vt/2,i=(this.Zt.song.loopStart-this.Zt.barScrollPos)*this.Yi,s=(this.Zt.song.loopStart+this.Zt.song.loopLength-this.Zt.barScrollPos)*this.Yi;this.os==i&&this.as==s||(this.os=i,this.as=s,this.ss.setAttribute("d","M "+(i+t)+" 2 L "+(s-t)+" 2 A "+(t-2)+" "+(t-2)+" 0 0 1 "+(s-t)+" "+(this.Vt-2)+" L "+(i+t)+" "+(this.Vt-2)+" A "+(t-2)+" "+(t-2)+" 0 0 1 "+(i+t)+" 2 z")),this.Mi()},i}();t.LoopEditor=i}(beepbox||(beepbox={})),function(t){var i=function(){function i(i){var s=this;this.Zt=i,this.ai=512,this.Vt=20,this.ls=t.svgElement("svg",{"pointer-events":"none"}),this.cs=t.svgElement("rect",{fill:"#444444",x:0,y:2,width:10,height:this.Vt-4}),this.fs=t.svgElement("rect",{fill:"none",stroke:"white","stroke-width":2,"pointer-events":"none",x:0,y:1,width:10,height:this.Vt-2}),this.vs=t.svgElement("path",{fill:"white","pointer-events":"none"}),this.ds=t.svgElement("path",{fill:"white","pointer-events":"none"}),this.jt=t.svgElement("svg",{style:"background-color: #000000; touch-action: pan-y; position: absolute;",width:this.ai,height:this.Vt},[this.ls,this.cs,this.fs,this.vs,this.ds]),this.container=t.html.div({style:"width: 512px; height: 20px; overflow: hidden; position: relative;"},[this.jt]),this.Ft=0,this.Wt=0,this.Jt=!1,this.Tt=!1,this.bs=!1,this.ws=-1,this.ps=-1,this.ui=function(t){s.Tt||(s.Tt=!0,s.Mi())},this.li=function(t){s.Tt&&(s.Tt=!1,s.Mi())},this.ci=function(t){t.preventDefault(),s.Jt=!0;var i=s.jt.getBoundingClientRect();s.Ft=(t.clientX||t.pageX)-i.left,s.Wt=(t.clientY||t.pageY)-i.top,s.Mi(),s.Ft>=s.Zt.barScrollPos*s.Yi&&s.Ft<=(s.Zt.barScrollPos+16)*s.Yi&&(s.bs=!0,s.ms=s.Ft)},this.vi=function(t){t.preventDefault(),s.Jt=!0;var i=s.jt.getBoundingClientRect();s.Ft=t.touches[0].clientX-i.left,s.Wt=t.touches[0].clientY-i.top,s.Mi(),s.Ft>=s.Zt.barScrollPos*s.Yi&&s.Ft<=(s.Zt.barScrollPos+16)*s.Yi&&(s.bs=!0,s.ms=s.Ft)},this.di=function(t){var i=s.jt.getBoundingClientRect();s.Ft=(t.clientX||t.pageX)-i.left,s.Wt=(t.clientY||t.pageY)-i.top,s.bi()},this.wi=function(t){if(s.Jt){t.preventDefault();var i=s.jt.getBoundingClientRect();s.Ft=t.touches[0].clientX-i.left,s.Wt=t.touches[0].clientY-i.top,s.bi()}},this.pi=function(t){!s.bs&&s.Jt&&(s.Ft<(s.Zt.barScrollPos+8)*s.Yi?(s.Zt.barScrollPos>0&&s.Zt.barScrollPos--,s.Zt.notifier.changed()):(s.Zt.barScrollPos<s.Zt.song.bars-16&&s.Zt.barScrollPos++,s.Zt.notifier.changed())),s.Jt=!1,s.bs=!1,s.Mi()},this.yi=function(){s.Yi=(s.ai-1)/Math.max(16,s.Zt.song.bars),s.Ki()},this.Zt.notifier.watch(this.yi),this.yi();var h=.5*this.Vt;this.vs.setAttribute("d","M 9 "+h+" L 20 "+(h+6)+" L 20 "+(h-6)+" z"),this.ds.setAttribute("d","M "+(this.ai-9)+" "+h+" L "+(this.ai-20)+" "+(h+6)+" L "+(this.ai-20)+" "+(h-6)+" z"),this.container.addEventListener("mousedown",this.ci),document.addEventListener("mousemove",this.di),document.addEventListener("mouseup",this.pi),this.container.addEventListener("mouseover",this.ui),this.container.addEventListener("mouseout",this.li),this.container.addEventListener("touchstart",this.vi),document.addEventListener("touchmove",this.wi),document.addEventListener("touchend",this.pi),document.addEventListener("touchcancel",this.pi)}return i.prototype.bi=function(){if(this.bs){for(;this.Ft-this.ms<.5*-this.Yi&&this.Zt.barScrollPos>0;)this.Zt.barScrollPos--,this.ms-=this.Yi,this.Zt.notifier.changed();for(;this.Ft-this.ms>.5*this.Yi&&this.Zt.barScrollPos<this.Zt.song.bars-16;)this.Zt.barScrollPos++,this.ms+=this.Yi,this.Zt.notifier.changed()}this.Tt&&this.Mi()},i.prototype.Mi=function(){var t=!1,i=!1,s=!1;this.Tt&&!this.Jt&&(this.Ft<this.Zt.barScrollPos*this.Yi?t=!0:this.Ft>(this.Zt.barScrollPos+16)*this.Yi?i=!0:s=!0),this.vs.style.visibility=t?"visible":"hidden",this.ds.style.visibility=i?"visible":"hidden",this.fs.style.visibility=s?"visible":"hidden"},i.prototype.Ki=function(){var i=this.ws!=this.Zt.song.bars;if(i){for(this.ws=this.Zt.song.bars;this.ls.firstChild;)this.ls.removeChild(this.ls.firstChild);for(var s=0;s<=this.Zt.song.bars;s++){var h=s%16==0?0:s%4==0?this.Vt/8:this.Vt/3;this.ls.appendChild(t.svgElement("rect",{fill:"#444444",x:s*this.Yi-1,y:h,width:2,height:this.Vt-2*h}))}}(i||this.ps!=this.Zt.barScrollPos)&&(this.ps=this.Zt.barScrollPos,this.cs.setAttribute("x",""+this.Yi*this.Zt.barScrollPos),this.cs.setAttribute("width",""+16*this.Yi),this.fs.setAttribute("x",""+this.Yi*this.Zt.barScrollPos),this.fs.setAttribute("width",""+16*this.Yi)),this.Mi()},i}();t.BarScrollBar=i}(beepbox||(beepbox={})),function(t){var i=function(){function i(i){var s=this;this.Zt=i,this.ai=20,this.Vt=481,this.gs=4,this.Ms=7,this.ys=(this.Vt-this.gs)/this.Ms,this.xs=3*this.ys+this.gs,this.cs=t.svgElement("rect",{fill:"#444444",x:2,y:0,width:this.ai-4,height:this.xs}),this.fs=t.svgElement("rect",{fill:"none",stroke:"white","stroke-width":2,"pointer-events":"none",x:1,y:0,width:this.ai-2,height:this.xs}),this.Li=t.svgElement("path",{fill:"white","pointer-events":"none"}),this.Vi=t.svgElement("path",{fill:"white","pointer-events":"none"}),this.jt=t.svgElement("svg",{style:"background-color: #000000; touch-action: pan-x; position: absolute;",width:this.ai,height:this.Vt}),this.container=t.html.div({id:"octaveScrollBarContainer",style:"width: 20px; height: 481px; overflow: hidden; position: relative;"},[this.jt]),this.Ft=0,this.Wt=0,this.Jt=!1,this.Tt=!1,this.bs=!1,this.As=-1,this.rs=null,this.ui=function(t){s.Tt||(s.Tt=!0,s.Mi())},this.li=function(t){s.Tt&&(s.Tt=!1,s.Mi())},this.ci=function(t){t.preventDefault(),s.Jt=!0;var i=s.jt.getBoundingClientRect();s.Ft=(t.clientX||t.pageX)-i.left,s.Wt=(t.clientY||t.pageY)-i.top,3!=s.Zt.channel&&(s.Mi(),s.Wt>=s.ks-s.xs&&s.Wt<=s.ks&&(s.bs=!0,s.ms=s.Wt))},this.vi=function(t){t.preventDefault(),s.Jt=!0;var i=s.jt.getBoundingClientRect();s.Ft=t.touches[0].clientX-i.left,s.Wt=t.touches[0].clientY-i.top,3!=s.Zt.channel&&(s.Mi(),s.Wt>=s.ks-s.xs&&s.Wt<=s.ks&&(s.bs=!0,s.ms=s.Wt))},this.di=function(t){var i=s.jt.getBoundingClientRect();s.Ft=(t.clientX||t.pageX)-i.left,s.Wt=(t.clientY||t.pageY)-i.top,s.bi()},this.wi=function(t){if(s.Jt){t.preventDefault();var i=s.jt.getBoundingClientRect();s.Ft=t.touches[0].clientX-i.left,s.Wt=t.touches[0].clientY-i.top,s.bi()}},this.pi=function(i){if(3!=s.Zt.channel&&!s.bs&&s.Jt){var h=s.Zt.history.lastChangeWas(s.rs),n=h?s.rs.oldValue:s.Zt.song.channelOctaves[s.Zt.channel],e=s.Zt.song.channelOctaves[s.Zt.channel];s.Wt<s.ks-.5*s.xs?e<4&&(s.rs=new t.ChangeOctave(s.Zt,n,e+1),s.Zt.history.record(s.rs,h)):e>0&&(s.rs=new t.ChangeOctave(s.Zt,n,e-1),s.Zt.history.record(s.rs,h))}s.Jt=!1,s.bs=!1,s.Mi()},this.yi=function(){s.ks=s.Vt-s.ys*s.Zt.song.channelOctaves[s.Zt.channel],s.Ki()},this.Zt.notifier.watch(this.yi),this.yi(),this.jt.appendChild(this.cs);for(var h=0;h<=this.Ms;h++)this.jt.appendChild(t.svgElement("rect",{fill:"#886644",x:0,y:h*this.ys,width:this.ai,height:this.gs}));this.jt.appendChild(this.fs),this.jt.appendChild(this.Li),this.jt.appendChild(this.Vi);var n=.5*this.ai;this.Li.setAttribute("d","M "+n+" 9 L "+(n+6)+" 20 L "+(n-6)+" 20 z"),this.Vi.setAttribute("d","M "+n+" "+(this.Vt-9)+" L "+(n+6)+" "+(this.Vt-20)+" L "+(n-6)+" "+(this.Vt-20)+" z"),this.container.addEventListener("mousedown",this.ci),document.addEventListener("mousemove",this.di),document.addEventListener("mouseup",this.pi),this.container.addEventListener("mouseover",this.ui),this.container.addEventListener("mouseout",this.li),this.container.addEventListener("touchstart",this.vi),document.addEventListener("touchmove",this.wi),document.addEventListener("touchend",this.pi),document.addEventListener("touchcancel",this.pi)}return i.prototype.bi=function(){if(3!=this.Zt.channel){if(this.bs){for(var i=this.Zt.song.channelOctaves[this.Zt.channel],s=this.Zt.history.lastChangeWas(this.rs),h=s?this.rs.oldValue:i,n=i;this.Wt-this.ms<.5*-this.ys&&n<4;)n++,this.ms-=this.ys;for(;this.Wt-this.ms>.5*this.ys&&n>0;)n--,this.ms+=this.ys;n!=i&&(this.rs=new t.ChangeOctave(this.Zt,h,n),this.Zt.history.record(this.rs,s))}this.Tt&&this.Mi()}},i.prototype.Mi=function(){var t=!1,i=!1,s=!1;this.Tt&&!this.Jt&&(this.Wt<this.ks-this.xs?t=!0:this.Wt>this.ks?i=!0:s=!0),this.Li.style.visibility=t?"inherit":"hidden",this.Vi.style.visibility=i?"inherit":"hidden",this.fs.style.visibility=s?"inherit":"hidden"},i.prototype.Ki=function(){this.jt.style.visibility=3==this.Zt.channel?"hidden":"visible",this.As!=this.ks&&(this.As=this.ks,this.cs.setAttribute("y",""+(this.ks-this.xs)),this.fs.setAttribute("y",""+(this.ks-this.xs))),this.Mi()},i}();t.OctaveScrollBar=i}(beepbox||(beepbox={})),function(t){var i=!1;function s(){0,i=!0}var h=document.createElement("img");h.onload=s,h.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NEU3RTM2RTg0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NEU3RTM2RTk0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozMzYxN0U3RDQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozMzYxN0U3RTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PomGIaQAAABgSURBVHjaYpSWlmZhYWFmZgaSTExMQAYTGGAyIICRkRFIMhANWISFhdlggAUHANrBysoKNBfuCGKMvnjx4r59+xhp5wOg6UCSBM+SB0YtGLVgCFgAzDeMeOSGgAUAAQYAGgwJrOg8pdQAAAAASUVORK5CYII=";var n=document.createElement("img");n.onload=s,n.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6NEU3RTM2RUM0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6NEU3RTM2RUQ0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo0RTdFMzZFQTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo0RTdFMzZFQjQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PhURscAAAAB1SURBVHja7NPBCoAgDAZgnaMX8Oj7P2KKldXPhiR4CwwCv4PInPvxoA0hMLNzDisRYUPCCiMucVallJzzJnaBih5pp2mw936puKEZ2qQ3MeUQmLiKGGNKCZ1IQr2fDnb0C8gMNgNmwA8Cnt/0Tv91vw64BRgALUuP70jrlrwAAAAASUVORK5CYII=";var e=document.createElement("img");e.onload=s,e.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzM2MTdFNzc0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzM2MTdFNzg0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozMzYxN0U3NTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozMzYxN0U3NjQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PgBmMXoAAACTSURBVHja7JQ7CgMhGIT3920M2Hko7+RJPYWViE0myi5sEXAhKQL7FcP8PmawkWKMjx2llNb60MNIKY0xnPPphRDbMsJ7/xw458wAodZa6PRQ5GIF0RjlYCU655xSEqWU3ntrrdb63RcgHcq2H3MX3AV/UEAhBL7DBkTEzmAFuzSY44UC/BDHtU+8z539esFLgAEAkZ4XCDjZXPEAAAAASUVORK5CYII=";var r=document.createElement("img");r.onload=s,r.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAANCAIAAABHKvtLAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6MzM2MTdFN0I0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6MzM2MTdFN0M0NzBEMTFFMTgyMjBBREEyQTVGRDY5MjIiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDozMzYxN0U3OTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDozMzYxN0U3QTQ3MEQxMUUxODIyMEFEQTJBNUZENjkyMiIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PlZjoH4AAADHSURBVHja7JTNDoMgEIRBGq21iTcfyvd/DeNvJBYBp7uFEE+99NDE70AMMDPLYZRt2z4CeZ4XRcFrRkgphRD7vnvvX8RGdF03DEPf99M0LcuitcamMcZa6wkRuNV1/SSqqroTcC/LEu5KKQ6AEhq21oRzDl5bAME8DUjd3wHjOELPyu9fgNnneV7XNQ6OyNPsTCZ+zBVwBfxBgGyaRgViuWIt+ZIPuAAaZwh00BKxaKeuSfwhUsfI55g+WOMT2DEl3jm94BBgAAtY6T6d3wTNAAAAAElFTkSuQmCC";var o=document.createElement("img");o.onload=s,o.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAArCAIAAACW3x1gAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA2ZpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0UmVmPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VSZWYjIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOk9yaWdpbmFsRG9jdW1lbnRJRD0ieG1wLmRpZDowMTgwMTE3NDA3MjA2ODExOUJCOEEzOUJCMkI3MTdFNCIgeG1wTU06RG9jdW1lbnRJRD0ieG1wLmRpZDo5NzVEOTA1QzQ5MjMxMUUxOTM3RDhDNEI4QkIxQkFCNSIgeG1wTU06SW5zdGFuY2VJRD0ieG1wLmlpZDo5NzVEOTA1QjQ5MjMxMUUxOTM3RDhDNEI4QkIxQkFCNSIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgQ1M1IE1hY2ludG9zaCI+IDx4bXBNTTpEZXJpdmVkRnJvbSBzdFJlZjppbnN0YW5jZUlEPSJ4bXAuaWlkOjAxODAxMTc0MDcyMDY4MTE5QkI4QTM5QkIyQjcxN0U0IiBzdFJlZjpkb2N1bWVudElEPSJ4bXAuZGlkOjAxODAxMTc0MDcyMDY4MTE5QkI4QTM5QkIyQjcxN0U0Ii8+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+dtFK5QAACbRJREFUeNrcV0lsG9cZnnmzcJdIcRHFRZtly5IVSVYSOcriNY7jqHHTBE2bJkCRNijQQ9re2kOBAj30kByKAm1PvQVF0RYIkLRpkiZuLMqyLVm7bGvlIpKiuHOGyww52+ubIbXYCYLk2P4ccobz3nzf+9f3D4b9rwv+5cOXL5x48crDT54b8Pr6jOZWQJoxKIi13WJ+Oziz+Z/r6x9N3AvMhb42gcWkf/P1Mz/40fkWz2iuAAsFrljkOK5crVYwTNTrcaMRNDURNhtl1Slrn9x55x+zf/5ooVIVvhLBq1ce+eXPLpt6RnZ22EIBmk1Oi8VuMFoMBgNF6RUMF2tcrVqscPlSKcGV4zaC85qNd25u/PHdm/+8tf5lBBRJ/Oan49/98cVEDmcYg9PZ09LSrjcYSRzHcAAxDGBQQfMgJiuyAiFUFMSUT23mtu9YxYxVgX/6YPa3796QZGUfk9i/Mhvo3//8W99443wwKtB0T1fXqM3m0en0iJUgSIIkKYoiKBL9A4QqAEcCSFJnbnI3uboqIpHP7D7T73WYDbfW4+IexwHB22+OX3zpsfAu5nI96vUM0gY9wqN0JEJG2AAATFs7hlABrhKgk3qJQwwCgrY4/ZiuaSceO+VvslkM11Yi9xG8+dLj33/tdDgLPB1POB09JE0RAOESFEEiVOWQaIZBPxCtX2MBUKVRMAXTWZyk2RaPRp440lIV5PngboPgZE/br16/kBJwR9dTTtdxQkejBzUOoHxO4P2CCAgcV+8iDSHUWWyA0ieDa4N++1J4N8VUVMVfvTCEm/S0vc/Z1g9IoKIjU6PHkCBvyrJ63hMJffZ+tQkyDnDVPThR18beM6zvHmky0i8/OYDAwTGvfXz0WKoCXL5BFVv1p0qgmULRMJTD0HVKWdqj1EZVS2meV+MNU1zHTmZE6tLJ7qOeFvLMQ504TRkt3SarC00j1aOBrhmksUxFu4PuNxytAqHAhZj2Bw2h6Kprgym40d5m9PXqmbXTA53gzIA/V+KaXZ3aTBSCuKrpniDMOo+yv/bGr3qCyv46VE8jDVCmIBT0t7mtK1fkn+rzgpPdrWy5arS2qloCXHMWdp8flYatZGVPm7rd7nc6psUV0BgQgsnhYbnacGcr8DltXE3UGZsxFNA4JAgcUzU/RHDoWsOFh2Pp8ES0OnX9anWAtNnK1wSf00paTIZG0UAhV19+4/uAHNCqc2Hj3n2CDCxDWRvU1FCLJuB43qijahyLiFG2wEZ5wr+gLOKac7USUX/+gVlQ1pahsdZKjEFHcxwPWIZpNus5JgUhPICqY+1B4XvAQItHrUjsDR6aiRRT9gAq2USzUccyLNhNpe0WI5uOYFrEoAPDDqHvoSJMcJ8Q+7f3J6rxIGP1hbKJsN1iQOAgtJNutZu5bKjEpmU1HNXQeABcKzsNIfeKqVbv8H0OLbCgamQIuXySS6y7rOZQIgO2M2WsxrealHRsSdEiW5Kkfez6uV47Dyg0+ANzgUbqIAfXDZBZn3eSoiJUorkyoMzW9bW1Tk+LkFtNJ1YQPApESZFAAxqAQ9jEYZK6aKPItJJaPdRPdmupGlnocDWvra4hcHCi7/jdxXtihe3yWFKx2+lsUJZESVKLxAH2F1A0wNEAsrooC5Ko5ggb38wsBbps+mqZXVxZHeg7Dvq7vYlo+c78vN9t7fSARPxmMrmuCKIgSfUqRnwxeEOQZQRBRnpDWcxur6QWPm3XcT67eX5uLrHD93V5SSOsWk2ttwMLNp9rePwiyZbC0Vs8X/R5T+gNFog41F2SOEjdevRrXhVFUS2sklTjSsmt21xw7ogZ8za3XEcyvdzS3KOXeeInlx9iC3IikqkKCZ2ROjr6kKXJVCjsRqMx9CRBGpHBkWXrW1g9nRG0pNpRRGav8Gw6thy995mhuHW81eSxmK4HpiYnrzNFU9+xXp/XQLz8aIel2RqeTZZrNVHYJYDi7u7s6OqkaaJQSEajYYbJ8xwvSgJaLDI3YuW5EsNkc7lIYmchEbtJC9tHHFS/z6GUuclrE4GJwG6BBpJ1bKy3WGXJ5WDs+WfOOX0t+UgmaqieOM1uXP2Xb/iUv+Nhv7+DYYRstlIoZLYj259rvMg2D+mwuq2ohjL81vTC8tQ0hyk7eRpyTd52W09P6/uBKXLmXuSlK7D3VM+tSAZugv7Lb3349otCOe3OxW3+oWb7gNXqwDAdhqHdX0I1BsNQ+8ZjWBXDOHQh88XY3EpoZml1ZjGdLP/ivX9cffcVtKcPDXdStHJ7bZtcjGS2Ntb7xwbDs2F2K4UX37rzMcOOQoN5RSpuNbnnjPYjlMkP6DaIm1AfpDZdQqlWSVVyMSYeTm5sJtZCHMOHd2q7O2T449+hXdPvd5wc7tpYX12OZslIEd6YWe4a7h+8PHT9D5/GVxhXEiTey2eC1aOnnINnUUuUx2vLtIGUqlKVq/FlgWf5ClstM1yF4Zk0F4zUIiGhkiLNgNxeLaDUfvzxXkAIgfmV7TJGcBJGSJUeFz36wllBlP/+6+suknQSlCGthGfyK7PpWKhcydckUYtRHBN5KZ/m4qHS+jK7OFNYmC6mNyRzlTIRSDlseT537uzApUvDk4HAX29s3C2olsUWk9K/r06jPBj94WmlJu68v4RuNpGEkzLCNJbbza98mL4qiowsj35vOLZVWL8VpnFcDwA6/AQt62FVwQSo7iVjj/WOP/fwzVs3PpicvVuAjcarJKhrawM5i8My+NoFqSxVtlKEApE1DQA4KKqd1nXrdb1Gw/jf/jL2/KPyO5+00bSVotCoorkexS9OkWPnB158eWxpbnYiEPgsrmyyh1rHGCOhztkF07SJOHrlrMnTVo3nFKaCdmgSRxs56kXU3a79lZ3NTz/JLORFXkG4yGwSVNFt7Y6nvzM2dubo7NTUxLVrEzH5Zgo+2PyGswJqarwUq0gV92ivf/wSbbFIGRayZVSP1WqM47pHbKH5TC3MCRW5TmBpt498e/TZN85RRHn6s4mF2flAVJ5Mavb6/K6K2pZvPuZ45ZK364jTfXzE2j5EQn95LsyvbJXWQ+VofDIci4vC00d9lMdlOuZ2DHndI242EgqjPJheiCdLE1vVqYSswC99wznVZ33hvOfKxQ5Ts6HJ3X0oD8xaHlQVoVCrJCq5OLMTSm5sJO4FObY6tVqcCnJrWfkrvaPpaXBxzP3sOd9zT3fYXSa9kab0lFhFVRPlAepAahUWJUEV5UE2XZ5azE6vl+YivCDDr/2WOdzfcmqkdWTINXDC4XXpzTqiWq7F42wwyKxuFO5sMneDxc0Ej/0/y38FGACBHjS0mkQ17AAAAABJRU5ErkJggg==";var a=function(){function s(s){var a=this;this.Zt=s,this.ns=t.html.canvas({width:"32",height:"481"}),this.es=t.html.canvas({width:"32",height:"40"}),this.container=t.html.div({style:"width: 32px; height: 481px; overflow:hidden; position: relative;"},[this.ns,this.es]),this.Ns=this.ns.getContext("2d"),this.Es=this.es.getContext("2d"),this.ai=32,this.Vt=481,this.Ft=0,this.Wt=0,this.Jt=!1,this.Tt=!1,this.Zs=-1,this.ri=!1,this.Rs=-1,this.ui=function(t){a.Tt||(a.Tt=!0,a.Mi())},this.li=function(t){a.Tt&&(a.Tt=!1,a.Mi())},this.ci=function(t){t.preventDefault(),a.Jt=!0;var i=a.ns.getBoundingClientRect();a.Ft=(t.clientX||t.pageX)-i.left,a.Wt=(t.clientY||t.pageY)-i.top,a.Zt.synth.pianoPressed=!0,a.Mi()},this.di=function(t){var i=a.ns.getBoundingClientRect();a.Ft=(t.clientX||t.pageX)-i.left,a.Wt=(t.clientY||t.pageY)-i.top,a.Is(),a.Zt.synth.pianoPitch=a.Gs+12*a.Zt.song.channelOctaves[a.Zt.channel],a.Mi()},this.Hi=function(t){a.Jt=!1,a.Zt.synth.pianoPressed=!1,a.Mi()},this.yi=function(){a.Ai=3==a.Zt.channel?40:13,a.ki=3==a.Zt.channel?t.Music.drumCount:t.Music.pitchCount,a.Is(),a.Zt.synth.pianoPitch=a.Gs+12*a.Zt.song.channelOctaves[a.Zt.channel],a.Zt.synth.pianoChannel=a.Zt.channel,a.Ki()},this.Ki=function(){if(i){if(a.Zt.showLetters&&(a.Zs!=a.Zt.song.scale||a.Rs!=a.Zt.song.key||a.ri!=(3==a.Zt.channel))){var s;a.Zs=a.Zt.song.scale,a.Rs=a.Zt.song.key,a.ri=3==a.Zt.channel,a.Ns.clearRect(0,0,a.ai,a.Vt);for(var u=0;u<a.ki;u++){var l=(u+t.Music.keyTransposes[a.Zt.song.key])%12;if(3==a.Zt.channel){s=o;var c=1-u/a.ki*.35,f=.5*(1-c),v=s.width*f,d=s.height*f+a.Ai*(a.ki-u-1),b=s.width*c,w=s.height*c;a.Ns.drawImage(s,v,d,b,w);for(var p=1+(u-a.ki/2)/a.ki*.5,m=a.Ns.getImageData(v,d,b,w),g=m.data,M=0;M<g.length;M+=4)g[M+0]*=p,g[M+1]*=p,g[M+2]*=p;a.Ns.putImageData(m,v,d)}else if(t.Music.scaleFlags[a.Zt.song.scale][u%12]){var y=t.Music.pitchNames[l];if(null==y){var x=t.Music.blackKeyNameParents[u%12];y=t.Music.pitchNames[(l+12+x)%12],1==x?y+="♭":-1==x&&(y+="♯")}var A=t.Music.pianoScaleFlags[l]?"#000000":"#ffffff";s=t.Music.pianoScaleFlags[l]?e:h,a.Ns.drawImage(s,0,a.Ai*(a.ki-u-1)),a.Ns.font="bold 11px sans-serif",a.Ns.fillStyle=A,a.Ns.fillText(y,15,a.Ai*(a.ki-u)-3)}else s=t.Music.pianoScaleFlags[l]?r:n,a.Ns.drawImage(s,0,a.Ai*(a.ki-u-1))}a.Mi()}}else window.requestAnimationFrame(a.Ki)},this.Zt.notifier.watch(this.yi),this.yi(),this.container.addEventListener("mousedown",this.ci),document.addEventListener("mousemove",this.di),document.addEventListener("mouseup",this.Hi),this.container.addEventListener("mouseover",this.ui),this.container.addEventListener("mouseout",this.li)}return s.prototype.Is=function(){var i=t.Music.scaleFlags[this.Zt.song.scale],s=Math.max(0,Math.min(this.ki-1,this.ki-this.Wt/this.Ai));if(i[Math.floor(s)%12]||3==this.Zt.channel)this.Gs=Math.floor(s);else{for(var h=Math.floor(s)+1,n=Math.floor(s)-1;!i[h%12];)h++;for(;!i[n%12];)n--;var e=h,r=n+1;h%12!=0&&h%12!=7||(e-=.5),n%12!=0&&n%12!=7||(r+=.5),this.Gs=s-r>e-s?h:n}},s.prototype.Mi=function(){this.es.style.visibility=!this.Tt||this.Jt?"hidden":"visible",this.Tt&&!this.Jt&&(this.Es.clearRect(0,0,32,40),this.es.style.left="0px",this.es.style.top=this.Ai*(this.ki-this.Gs-1)+"px",this.Es.lineWidth=2,this.Es.strokeStyle="#ffffff",this.Es.strokeRect(1,1,this.ai-2,this.Ai-2))},s}();t.Piano=a}(beepbox||(beepbox={})),function(t){var i=function(){function t(){this.Bs=!0}return t.prototype.Ss=function(){this.Bs=!1},t.prototype.isNoop=function(){return this.Bs},t}();t.Change=i;var s=function(t){function i(i){var s=t.call(this)||this;return s.Cs=i,s.js=!i,s}return __extends(i,t),i.prototype.undo=function(){this.Cs?(this.Ds(),this.js=!0):(this.Us(),this.js=!1)},i.prototype.redo=function(){this.Cs?(this.Us(),this.js=!1):(this.Ds(),this.js=!0)},i.prototype.Ys=function(){return this.js},i.prototype.Ds=function(){throw new Error("Change.doForwards(): Override me.")},i.prototype.Us=function(){throw new Error("Change.doBackwards(): Override me.")},i}(i);t.UndoableChange=s;var h=function(t){function i(){return t.call(this)||this}return __extends(i,t),i.prototype.append=function(t){t.isNoop()||this.Ss()},i}(i);t.ChangeGroup=h;var n=function(t){function i(i){var s=t.call(this,!1)||this;return s.zs=void 0==i?[]:i.concat(),s}return __extends(i,t),i.prototype.append=function(t){t.isNoop()||(this.zs[this.zs.length]=t,this.Ss())},i.prototype.Ds=function(){for(var t=0;t<this.zs.length;t++)this.zs[t].redo()},i.prototype.Us=function(){for(var t=this.zs.length-1;t>=0;t--)this.zs[t].undo()},i}(s);t.ChangeSequence=n}(beepbox||(beepbox={})),function(t){var i=function(t){function i(i,s){var h=t.call(this,!1)||this;return h.Ls=i,h.Vs=s,h.Fs=h.Vs.start,h.Ws=h.Vs.end,h.Js=h.Vs.start,h.Ts=h.Vs.end,h.Os=h.Vs.pins,h.Ps=[],h.Qs=h.Vs.pitches,h.Xs=[],h}return __extends(i,t),i.prototype.Hs=function(){for(var t=0;t<this.Ps.length-1;)this.Ps[t].time>=this.Ps[t+1].time?this.Ps.splice(t,1):t++;for(t=1;t<this.Ps.length-1;)this.Ps[t-1].interval==this.Ps[t].interval&&this.Ps[t].interval==this.Ps[t+1].interval&&this.Ps[t-1].volume==this.Ps[t].volume&&this.Ps[t].volume==this.Ps[t+1].volume?this.Ps.splice(t,1):t++;var i=this.Ps[0].interval,s=this.Ps[0].time;for(t=0;t<this.Qs.length;t++)this.Xs[t]=this.Qs[t]+i;for(t=0;t<this.Ps.length;t++)this.Ps[t].interval-=i,this.Ps[t].time-=s;this.Js=this.Fs+s,this.Ts=this.Js+this.Ps[this.Ps.length-1].time,this.Ds(),this.Ss()},i.prototype.Ds=function(){this.Vs.pins=this.Ps,this.Vs.pitches=this.Xs,this.Vs.start=this.Js,this.Vs.end=this.Ts,this.Ls.notifier.changed()},i.prototype.Us=function(){this.Vs.pins=this.Os,this.Vs.pitches=this.Qs,this.Vs.start=this.Fs,this.Vs.end=this.Ws,this.Ls.notifier.changed()},i}(t.UndoableChange);t.ChangePins=i;var s=function(t){function i(i,s){var h=t.call(this)||this;return i.song.instrumentEnvelopes[i.channel][i.getCurrentInstrument()]!=s&&(h.Ss(),i.song.instrumentEnvelopes[i.channel][i.getCurrentInstrument()]=s,i.notifier.changed()),h}return __extends(i,t),i}(t.Change);t.ChangeEnvelope=s;var h=function(t){function i(i,s,h){var n=t.call(this)||this;if(n.oldValue=s,h>i.song.channelPatterns[i.channel].length)throw new Error("invalid pattern");return i.song.channelBars[i.channel][i.bar]=h,i.notifier.changed(),s!=h&&n.Ss(),n}return __extends(i,t),i}(t.Change);t.ChangeBarPattern=h;var n=function(i){function s(s,h){var n=i.call(this)||this;if(s.song.bars!=h){for(var e=[],r=0;r<t.Music.numChannels;r++){for(var o=[],a=0;a<h;a++)o.push(a<s.song.bars?s.song.channelBars[r][a]:1);e.push(o)}var u=s.bar,l=s.barScrollPos,c=s.song.loopStart,f=s.song.loopLength;s.song.bars>h&&(u=Math.min(u,h-1),l=Math.max(0,Math.min(h-16,l)),f=Math.min(h,f),c=Math.min(h-f,c)),s.bar=u,s.barScrollPos=l,s.song.loopStart=c,s.song.loopLength=f,s.song.bars=h,s.song.channelBars=e,s.notifier.changed(),n.Ss()}return n}return __extends(s,i),s}(t.Change);t.ChangeBars=n;var e=function(i){function s(s,h){var n=i.call(this)||this;if(s.song.beats!=h){if(s.song.beats>h)for(var e=new t.ChangeSequence,r=0;r<t.Music.numChannels;r++)for(var o=0;o<s.song.channelPatterns[r].length;o++)e.append(new I(s,s.song.channelPatterns[r][o],h*s.song.parts,s.song.beats*s.song.parts));s.song.beats=h,s.notifier.changed(),n.Ss()}return n}return __extends(s,i),s}(t.Change);t.ChangeBeats=e;var r=function(t){function i(i,s,h){var n=t.call(this)||this,e=i.channel,r=i.bar;return i.channel=s,i.bar=h,i.barScrollPos=Math.min(i.bar,Math.max(i.bar-15,i.barScrollPos)),i.notifier.changed(),e==s&&r==h||n.Ss(),n}return __extends(i,t),i}(t.Change);t.ChangeChannelBar=r;var o=function(t){function i(i,s){var h=t.call(this)||this;return i.song.instrumentChorus[i.channel][i.getCurrentInstrument()]!=s&&(h.Ss(),i.song.instrumentChorus[i.channel][i.getCurrentInstrument()]=s,i.notifier.changed()),h}return __extends(i,t),i}(t.Change);t.ChangeChorus=o;var a=function(t){function i(i,s){var h=t.call(this)||this;return i.song.instrumentEffects[i.channel][i.getCurrentInstrument()]!=s&&(i.song.instrumentEffects[i.channel][i.getCurrentInstrument()]=s,i.notifier.changed(),h.Ss()),h}return __extends(i,t),i}(t.Change);t.ChangeEffect=a;var u=function(t){function i(i,s){var h=t.call(this)||this;return i.song.instrumentFilters[i.channel][i.getCurrentInstrument()]!=s&&(i.song.instrumentFilters[i.channel][i.getCurrentInstrument()]=s,i.notifier.changed(),h.Ss()),h}return __extends(i,t),i}(t.Change);t.ChangeFilter=u;var l=function(i){function s(s,h){var n=i.call(this)||this,e=s.song.instruments,r=h;if(s.song.instruments!=r){for(var o=[],a=[],u=[],l=[],c=[],f=[],v=[s.song.instrumentWaves,s.song.instrumentFilters,s.song.instrumentEnvelopes,s.song.instrumentEffects,s.song.instrumentChorus,s.song.instrumentVolumes],d=[o,a,u,l,c,f],b=0;b<d.length;b++)for(var w=v[b],p=d[b],m=0;m<t.Music.numChannels;m++){for(var g=[],M=0;M<r;M++)M<e?g.push(w[m][M]):0==b?g.push(1):2==b?g.push(1):g.push(0);p.push(g)}var y=[];for(m=0;m<t.Music.numChannels;m++){var x=[],A=[];for(M=0;M<s.song.patterns;M++){var k=s.song.channelPatterns[m][M].instrument;x.push(k),A.push(k<r?k:0)}y.push(A)}s.song.instruments=r,s.song.instrumentWaves=o,s.song.instrumentFilters=a,s.song.instrumentEnvelopes=u,s.song.instrumentEffects=l,s.song.instrumentChorus=c,s.song.instrumentVolumes=f;for(m=0;m<t.Music.numChannels;m++)for(M=0;M<s.song.patterns;M++)s.song.channelPatterns[m][M].instrument=y[m][M];s.notifier.changed(),n.Ss()}return n}return __extends(s,i),s}(t.Change);t.ChangeInstruments=l;var c=function(t){function i(i,s){var h=t.call(this)||this;return i.song.key!=s&&(i.song.key=s,i.notifier.changed(),h.Ss()),h}return __extends(i,t),i}(t.Change);t.ChangeKey=c;var f=function(t){function i(i,s,h,n,e){var r=t.call(this)||this;return r.Ls=i,r.oldStart=s,r.oldLength=h,r.newStart=n,r.newLength=e,r.Ls.song.loopStart=r.newStart,r.Ls.song.loopLength=r.newLength,r.Ls.notifier.changed(),r.oldStart==r.newStart&&r.oldLength==r.newLength||r.Ss(),r}return __extends(i,t),i}(t.Change);t.ChangeLoop=f;var v=function(t){function i(i,s,h,n,e,r){void 0===r&&(r=!1);var o=t.call(this,r)||this;return o.Ls=i,o.ti=s,o.Vs=h,o.Ks=n,o._s=e,o.Ss(),o.redo(),o}return __extends(i,t),i.prototype.Ds=function(){this.Vs.pitches.splice(this._s,0,this.Ks),this.Ls.notifier.changed()},i.prototype.Us=function(){this.Vs.pitches.splice(this._s,1),this.Ls.notifier.changed()},i}(t.UndoableChange);t.ChangePitchAdded=v;var d=function(t){function i(i,s,h){var n=t.call(this)||this;return n.oldValue=s,i.song.channelOctaves[i.channel]=h,i.notifier.changed(),s!=h&&n.Ss(),n}return __extends(i,t),i}(t.Change);t.ChangeOctave=d;var b=function(i){function s(s,h){var n=i.call(this)||this;if(s.song.parts!=h){for(var e=0;e<t.Music.numChannels;e++)for(var r=0;r<s.song.channelPatterns[e].length;r++)n.append(new y(s,s.song.channelPatterns[e][r],s.song.parts,h));s.song.parts=h,s.notifier.changed(),n.Ss()}return n}return __extends(s,i),s}(t.ChangeGroup);t.ChangeParts=b;var w=function(t){function i(i,s,h,n,e){var r=t.call(this)||this;return s.notes=h,i.song.parts!=e&&r.append(new y(i,s,e,i.song.parts)),i.song.beats!=n&&r.append(new I(i,s,i.song.beats*i.song.parts,n*i.song.parts)),i.notifier.changed(),r.Ss(),r}return __extends(i,t),i}(t.ChangeGroup);t.ChangePaste=w;var p=function(t){function i(i,s,h){var n=t.call(this)||this;return h.instrument!=s&&(h.instrument=s,i.notifier.changed(),n.Ss()),n}return __extends(i,t),i}(t.Change);t.ChangePatternInstrument=p;var m=function(i){function s(s,h){var n=i.call(this)||this;if(s.song.patterns!=h){for(var e=0;e<t.Music.numChannels;e++){for(var r=s.song.channelBars[e],o=s.song.channelPatterns[e],a=0;a<r.length;a++)r[a]>h&&(r[a]=0);for(a=o.length;a<h;a++)o[a]=new t.BarPattern;o.length=h}s.song.patterns=h,s.notifier.changed(),n.Ss()}return n}return __extends(s,i),s}(t.Change);t.ChangePatterns=m;var g=function(i){function s(s,h,n,e){var r=i.call(this,s,h)||this;e-=r.Fs;for(var o=r.Os[n].time,a=Math.min(o,e),u=Math.max(o,e),l=!1,c=0;c<r.Os.length;c++){var f=h.pins[c],v=f.time;v<a?r.Ps.push(t.makeNotePin(f.interval,v,f.volume)):v>u&&(l||(r.Ps.push(t.makeNotePin(r.Os[n].interval,e,r.Os[n].volume)),l=!0),r.Ps.push(t.makeNotePin(f.interval,v,f.volume)))}return l||r.Ps.push(t.makeNotePin(r.Os[n].interval,e,r.Os[n].volume)),r.Hs(),r}return __extends(s,i),s}(i);t.ChangePinTime=g;var M=function(i){function s(s,h,n,e,r,o){var a=i.call(this,s,h)||this;n-=a.Fs,e-=a.Fs,r-=h.pitches[o];var u,l,c,f,v=!1,d=!1,b=0,w=3,p=!0;for(e>n?(u=0,l=1,c=h.pins.length,f=function(t){a.Ps.push(t)}):(u=h.pins.length-1,l=-1,c=-1,f=function(t){a.Ps.unshift(t)});u!=c;u+=l)for(var m=h.pins[u],g=m.time;;)if(v){if(d){if(g*l==e*l)break;m.interval!=b&&(p=!1),f(t.makeNotePin(p?r:m.interval,g,m.volume));break}if(g*l<=e*l&&(b=m.interval,w=m.volume),g*l<e*l)break;f(t.makeNotePin(r,e,w)),d=!0}else{if(g*l<=n*l&&(b=m.interval,w=m.volume),g*l<n*l){f(t.makeNotePin(m.interval,g,m.volume));break}f(t.makeNotePin(b,n,w)),v=!0}return d||f(t.makeNotePin(r,e,w)),a.Hs(),a}return __extends(s,i),s}(i);t.ChangePitchBend=M;var y=function(t){function i(i,s,h,n){var e,r=t.call(this)||this;if(4==h&&3==n)e=function(t){return Math.ceil(3*t/4)};else{if(3!=h||4!=n)throw new Error("ChangeRhythm couldn't handle rhythm change from "+h+" to "+n+".");e=function(t){return Math.floor(4*t/3)}}for(var o=0;o<s.notes.length;){var a=s.notes[o];e(a.start)>=e(a.end)?r.append(new Z(i,s,a,o,!0)):(r.append(new x(i,a,e)),o++)}return r}return __extends(i,t),i}(t.ChangeSequence);t.ChangeRhythm=y;var x=function(i){function s(s,h,n){for(var e=i.call(this,s,h)||this,r=0,o=e.Os;r<o.length;r++){var a=o[r];e.Ps.push(t.makeNotePin(a.interval,n(a.time+e.Fs)-e.Fs,a.volume))}return e.Hs(),e}return __extends(s,i),s}(i);t.ChangeRhythmNote=x;var A=function(t){function i(i,s){var h=t.call(this)||this;return i.song.scale!=s&&(i.song.scale=s,i.notifier.changed(),h.Ss()),h}return __extends(i,t),i}(t.Change);t.ChangeScale=A;var k=function(t){function i(i,s){var h=t.call(this)||this;return i.song.fromBase64String(s),i.bar=Math.max(0,Math.min(i.song.bars-1,i.bar)),i.barScrollPos=Math.max(0,Math.min(i.song.bars-16,i.barScrollPos)),i.barScrollPos=Math.min(i.bar,Math.max(i.bar-15,i.barScrollPos)),i.notifier.changed(),h.Ss(),h}return __extends(i,t),i}(t.Change);t.ChangeSong=k;var N=function(t){function i(i,s,h){var n=t.call(this)||this;return n.oldValue=s,i.song.tempo=h,i.notifier.changed(),s!=h&&n.Ss(),n}return __extends(i,t),i}(t.Change);t.ChangeTempo=N;var E=function(t){function i(i,s,h){var n=t.call(this)||this;return n.oldValue=s,i.song.reverb=h,i.notifier.changed(),s!=h&&n.Ss(),n}return __extends(i,t),i}(t.Change);t.ChangeReverb=E;var Z=function(t){function i(i,s,h,n,e){void 0===e&&(e=!1);var r=t.call(this,e)||this;return r.Ls=i,r.R=s,r.Vs=h,r._s=n,r.Ss(),r.redo(),r}return __extends(i,t),i.prototype.Ds=function(){this.R.notes.splice(this._s,0,this.Vs),this.Ls.notifier.changed()},i.prototype.Us=function(){this.R.notes.splice(this._s,1),this.Ls.notifier.changed()},i}(t.UndoableChange);t.ChangeNoteAdded=Z;var R=function(i){function s(s,h,n,e){var r=i.call(this,s,h)||this;n-=r.Fs,e-=r.Fs;var o,a=!1,u=r.Os[0].volume,l=r.Os[0].interval,c=!0;for(o=0;o<r.Os.length;o++){var f=r.Os[o];if(f.time<n)u=f.volume,l=f.interval;else{if(!(f.time<=e))break;if(f.time>n&&!a&&r.Ps.push(t.makeNotePin(l,n,u)),r.Ps.push(t.makeNotePin(f.interval,f.time,f.volume)),a=!0,f.time==e){c=!1;break}}}return c&&r.Ps.push(t.makeNotePin(r.Os[o].interval,e,r.Os[o].volume)),r.Hs(),r}return __extends(s,i),s}(i);t.ChangeNoteLength=R;var I=function(t){function i(i,s,h,n,e){for(var r=t.call(this)||this,o=0;o<s.notes.length;){var a=s.notes[o];if(a==e&&void 0!=e)o++;else if(a.end<=h)o++;else{if(a.start>=n)break;a.start<h?(r.append(new R(i,a,a.start,h)),o++):a.end>n?(r.append(new R(i,a,n,a.end)),o++):r.append(new Z(i,s,a,o,!0))}}return r}return __extends(i,t),i}(t.ChangeSequence);t.ChangeNoteTruncate=I;var G=function(i){function s(s,h,n){var e=i.call(this,!1)||this;e.Ls=s,e.Vs=h,e.Os=h.pins,e.Ps=[],e.Qs=h.pitches,e.Xs=[];for(var r=3==s.channel?t.Music.drumCount-1:t.Music.maxPitch,o=0;o<e.Qs.length;o++){var a=e.Qs[o];if(n){for(var u=a+1;u<=r;u++)if(3==s.channel||t.Music.scaleFlags[s.song.scale][u%12]){a=u;break}}else for(u=a-1;u>=0;u--)if(3==s.channel||t.Music.scaleFlags[s.song.scale][u%12]){a=u;break}var l=!1;for(u=0;u<e.Xs.length;u++)if(e.Xs[u]==a){l=!0;break}l||e.Xs.push(a)}var c=0,f=r;for(o=1;o<e.Xs.length;o++){var v=e.Xs[0]-e.Xs[o];c<v&&(c=v),f>v+r&&(f=v+r)}for(var d=0,b=e.Os;d<b.length;d++){var w=b[d],p=w.interval+e.Qs[0];if(p<c&&(p=c),p>f&&(p=f),n){for(o=p+1;o<=f;o++)if(3==s.channel||t.Music.scaleFlags[s.song.scale][o%12]){p=o;break}}else for(o=p-1;o>=c;o--)if(3==s.channel||t.Music.scaleFlags[s.song.scale][o%12]){p=o;break}p-=e.Xs[0],e.Ps.push(t.makeNotePin(p,w.time,w.volume))}if(0!=e.Ps[0].interval)throw new Error("wrong pin start interval");for(o=1;o<e.Ps.length-1;)e.Ps[o-1].interval==e.Ps[o].interval&&e.Ps[o].interval==e.Ps[o+1].interval&&e.Ps[o-1].volume==e.Ps[o].volume&&e.Ps[o].volume==e.Ps[o+1].volume?e.Ps.splice(o,1):o++;return e.Ds(),e.Ss(),e}return __extends(s,i),s.prototype.Ds=function(){this.Vs.pins=this.Ps,this.Vs.pitches=this.Xs,this.Ls.notifier.changed()},s.prototype.Us=function(){this.Vs.pins=this.Os,this.Vs.pitches=this.Qs,this.Ls.notifier.changed()},s}(t.UndoableChange);t.ChangeTransposeNote=G;var B=function(t){function i(i,s,h){for(var n=t.call(this)||this,e=0;e<s.notes.length;e++)n.append(new G(i,s.notes[e],h));return n}return __extends(i,t),i}(t.ChangeSequence);t.ChangeTranspose=B;var S=function(t){function i(i,s,h){var n=t.call(this)||this;return n.oldValue=s,i.song.instrumentVolumes[i.channel][i.getCurrentInstrument()]=h,i.notifier.changed(),s!=h&&n.Ss(),n}return __extends(i,t),i}(t.Change);t.ChangeVolume=S;var C=function(i){function s(s,h,n,e,r,o){var a=i.call(this,!1)||this;a.Ls=s,a.R=h,a.Vs=n,a.Os=n.pins,a.Ps=[];for(var u=!1,l=0,c=n.pins;l<c.length;l++){var f=c[l];f.time<e?a.Ps.push(f):f.time==e?(a.Ps.push(t.makeNotePin(o,e,r)),u=!0):(u||(a.Ps.push(t.makeNotePin(o,e,r)),u=!0),a.Ps.push(f))}for(var v=1;v<a.Ps.length-1;)a.Ps[v-1].interval==a.Ps[v].interval&&a.Ps[v].interval==a.Ps[v+1].interval&&a.Ps[v-1].volume==a.Ps[v].volume&&a.Ps[v].volume==a.Ps[v+1].volume?a.Ps.splice(v,1):v++;return a.Ds(),a.Ss(),a}return __extends(s,i),s.prototype.Ds=function(){this.Vs.pins=this.Ps,this.Ls.notifier.changed()},s.prototype.Us=function(){this.Vs.pins=this.Os,this.Ls.notifier.changed()},s}(t.UndoableChange);t.ChangeVolumeBend=C;var j=function(t){function i(i,s){var h=t.call(this)||this;return i.song.instrumentWaves[i.channel][i.getCurrentInstrument()]!=s&&(i.song.instrumentWaves[i.channel][i.getCurrentInstrument()]=s,i.notifier.changed(),h.Ss()),h}return __extends(i,t),i}(t.Change);t.ChangeWave=j}(beepbox||(beepbox={})),function(t){var i=t.html.button,s=t.html.div,h=t.html.span,n=t.html.input,e=t.html.br,r=t.html.text,o=function(){function o(a,u){var l=this;this.Zt=a,this.Ui=u,this.qs=n({style:"width: 3em; margin-left: 1em;",type:"number",min:"1",max:"128",step:"1"}),this.$s=n({style:"width: 3em; margin-left: 1em;",type:"number",min:"1",max:"128",step:"1"}),this.th=n({style:"width: 3em; margin-left: 1em;",type:"number",min:"1",max:"32",step:"1"}),this.ih=n({style:"width: 3em; margin-left: 1em;",type:"number",min:"1",max:"10",step:"1"}),this.sh=i({style:"width:45%;"},[r("Okay")]),this.hh=i({style:"width:45%;"},[r("Cancel")]),this.container=s({className:"prompt",style:"width: 250px;"},[s({style:"font-size: 2em"},[r("Custom Song Size")]),s({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},[s({style:"text-align: right;"},[r("Beats per bar:"),e(),h({style:"font-size: smaller; color: #888888;"},[r("(Multiples of 3 or 4 are recommended)")])]),this.qs]),s({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},[s({style:"display: inline-block; text-align: right;"},[r("Bars per song:"),e(),h({style:"font-size: smaller; color: #888888;"},[r("(Multiples of 2 or 4 are recommended)")])]),this.$s]),s({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},[r("Patterns per channel:"),this.th]),s({style:"display: flex; flex-direction: row; align-items: center; height: 2em; justify-content: flex-end;"},[r("Instruments per channel:"),this.ih]),s({style:"display: flex; flex-direction: row; justify-content: space-between;"},[this.sh,this.hh])]),this.nh=function(){l.Zt.undo()},this.cleanUp=function(){l.sh.removeEventListener("click",l.eh),l.hh.removeEventListener("click",l.nh),l.qs.removeEventListener("keypress",o.rh),l.$s.removeEventListener("keypress",o.rh),l.th.removeEventListener("keypress",o.rh),l.ih.removeEventListener("keypress",o.rh),l.qs.removeEventListener("blur",o.oh),l.$s.removeEventListener("blur",o.oh),l.th.removeEventListener("blur",o.oh),l.ih.removeEventListener("blur",o.oh)},this.eh=function(){var i=new t.ChangeGroup;i.append(new t.ChangeBeats(l.Zt,o.ah(l.qs))),i.append(new t.ChangeBars(l.Zt,o.ah(l.$s))),i.append(new t.ChangePatterns(l.Zt,o.ah(l.th))),i.append(new t.ChangeInstruments(l.Zt,o.ah(l.ih))),l.Zt.prompt=null,l.Zt.history.record(i,!0)},this.qs.value=this.Zt.song.beats+"",this.qs.min=t.Music.beatsMin+"",this.qs.max=t.Music.beatsMax+"",this.$s.value=this.Zt.song.bars+"",this.$s.min=t.Music.barsMin+"",this.$s.max=t.Music.barsMax+"",this.th.value=this.Zt.song.patterns+"",this.th.min=t.Music.patternsMin+"",this.th.max=t.Music.patternsMax+"",this.ih.value=this.Zt.song.instruments+"",this.ih.min=t.Music.instrumentsMin+"",this.ih.max=t.Music.instrumentsMax+"",this.sh.addEventListener("click",this.eh),this.hh.addEventListener("click",this.nh),this.qs.addEventListener("keypress",o.rh),this.$s.addEventListener("keypress",o.rh),this.th.addEventListener("keypress",o.rh),this.ih.addEventListener("keypress",o.rh),this.qs.addEventListener("blur",o.oh),this.$s.addEventListener("blur",o.oh),this.th.addEventListener("blur",o.oh),this.ih.addEventListener("blur",o.oh)}return o.rh=function(t){var i=t.which?t.which:t.keyCode;return 46!=i&&i>31&&(i<48||i>57)&&(t.preventDefault(),!0)},o.oh=function(t){var i=t.target;i.value=Math.floor(Math.max(Number(i.min),Math.min(Number(i.max),Number(i.value))))+""},o.ah=function(t){return Math.floor(Number(t.value))},o}();t.SongDurationPrompt=o}(beepbox||(beepbox={})),function(t){var i=t.html.button,s=t.html.div,h=t.html.input,n=t.html.text;function e(t,i,s){return t+s*(i-t)}function r(t,i){if(navigator.msSaveOrOpenBlob)navigator.msSaveOrOpenBlob(t,i);else{var s=document.createElement("a");if(void 0!=s.download){var h=URL.createObjectURL(t);setTimeout(function(){URL.revokeObjectURL(h)},6e4),s.href=h,s.download=i,s.dispatchEvent(new MouseEvent("click"))}else if(navigator.vendor.indexOf("Apple")>-1){var n=new FileReader;n.onloadend=function(){console.log(n.result);var t=n.result.replace(/^data:[^;]*;/,"data:attachment/file;");window.open(t,"_blank")||(window.location.href=t)},n.readAsDataURL(t)}else{var e=URL.createObjectURL(t);setTimeout(function(){URL.revokeObjectURL(e)},6e4),window.open(e,"_blank")||(window.location.href=e)}}}ArrayBuffer.transfer||(ArrayBuffer.transfer=function(t,i){var s=new ArrayBuffer(i);if(!(t instanceof ArrayBuffer&&s instanceof ArrayBuffer))throw new TypeError("Source and destination must be ArrayBuffer instances");for(var h=0,n=Math.min(t.byteLength,s.byteLength),e=0,r=[8,4,2,1];e<r.length;e++){var o=r[e];if(n>=o){var a=u(o,t,s,h,n);h=a.nextOffset,n=a.leftBytes}}return s;function u(t,i,s,h,n){var e=Uint8Array;switch(t){case 8:e=Float64Array;break;case 4:e=Float32Array;break;case 2:e=Uint16Array;break;case 1:default:e=Uint8Array}for(var r=new e(i,h,n/t|0),o=new e(s,h,n/t|0),a=0;a<o.length;a++)o[a]=r[a];return{nextOffset:r.byteOffset+r.byteLength,leftBytes:n-o.length*t}}});var o=function(){function o(a,u){var l=this;this.Zt=a,this.Ui=u,this.uh=h({type:"text",style:"width: 10em;",value:"BeepBox-Song",maxlength:250}),this.lh=h({type:"checkbox"}),this.fh=h({style:"width: 2em;",type:"number",min:"1",max:"4",step:"1"}),this.vh=h({type:"checkbox"}),this.dh=i({},[n("Export to .wav file")]),this.bh=i({},[n("Export to .midi file")]),this.wh=i({},[n("Export to .json file")]),this.hh=i({},[n("Cancel")]),this.container=s({className:"prompt",style:"width: 200px;"},[s({style:"font-size: 2em"},[n("Export Options")]),s({style:"display: flex; flex-direction: row; align-items: center; justify-content: space-between;"},[n("File name:"),this.uh]),s({style:"display: table; width: 100%;"},[s({style:"display: table-row;"},[s({style:"display: table-cell;"},[n("Intro:")]),s({style:"display: table-cell;"},[n("Loop Count:")]),s({style:"display: table-cell;"},[n("Outro:")])]),s({style:"display: table-row;"},[s({style:"display: table-cell; vertical-align: middle;"},[this.lh]),s({style:"display: table-cell; vertical-align: middle;"},[this.fh]),s({style:"display: table-cell; vertical-align: middle;"},[this.vh])])]),this.dh,this.bh,this.wh,this.hh]),this.nh=function(){l.Zt.undo()},this.cleanUp=function(){l.uh.removeEventListener("input",o.ph),l.fh.removeEventListener("blur",o.oh),l.dh.removeEventListener("click",l.mh),l.bh.removeEventListener("click",l.gh),l.wh.removeEventListener("click",l.Mh),l.hh.removeEventListener("click",l.nh)},this.mh=function(){var i=new t.Synth(l.Zt.song);if(i.enableIntro=l.lh.checked,i.enableOutro=l.vh.checked,i.loopCount=Number(l.fh.value),!i.enableIntro)for(var s=0;s<l.Zt.song.loopStart;s++)i.nextBar();var h=i.totalSamples,n=new Float32Array(h);i.synthesize(n,h);var e,o,a,u=1*h,c=0,f=new ArrayBuffer(44+2*u),v=new DataView(f);v.setUint32(c,1380533830,!1),c+=4,v.setUint32(c,36+2*u,!0),c+=4,v.setUint32(c,1463899717,!1),c+=4,v.setUint32(c,1718449184,!1),c+=4,v.setUint32(c,16,!0),c+=4,v.setUint16(c,1,!0),c+=2,v.setUint16(c,1,!0),c+=2,v.setUint32(c,44100,!0),c+=4,v.setUint32(c,88200,!0),c+=4,v.setUint16(c,2,!0),c+=2,v.setUint16(c,16,!0),c+=2,v.setUint32(c,1684108385,!1),c+=4,v.setUint32(c,2*u,!0),c+=4,e=1,o=1;for(var d=0;d<h;d++){a=Math.floor(32767*n[d*e]);for(var b=0;b<o;b++)v.setInt16(c,a,!0),c+=2}r(new Blob([f],{type:"audio/wav"}),l.uh.value.trim()+".wav"),l.nh()},this.gh=function(){var i=0,s=0,h=new ArrayBuffer(1024),n=new DataView(h);function o(t){(s+=t)>h.byteLength&&(h=ArrayBuffer.transfer(h,Math.max(2*h.byteLength,s)),n=new DataView(h))}function a(t){t>>>=0,o(4),n.setUint32(i,t,!1),i=s}function u(t){t>>>=0,o(3),n.setUint8(i,t>>16&255),n.setUint8(i+1,t>>8&255),n.setUint8(i+2,255&t),i=s}function c(t){t>>>=0,o(2),n.setUint16(i,t,!1),i=s}function f(t){t>>>=0,o(1),n.setUint8(i,t),i=s}function v(t,h){h=h>>>0&127|(1&t)<<7,o(1),n.setUint8(i,h),i=s}function d(t){if((t>>>=0)>268435455)throw new Error("writeVariableLength value too big.");for(var i=!1,s=0;s<4;s++){var h=t>>>21-7*s&127;0==h&&3!=s||(i=!0),i&&v(3==s?0:1,h)}}function b(t){d(t.length);for(var i=0;i<t.length;i++){var s=t.charCodeAt(i);if(s>127)throw new Error("Trying to write unicode character as ascii.");f(s)}}var w=l.Zt.song,p=96/w.parts,m=p/4,g=w.getBeatsPerMinute(),M=Math.round(6e7/g),y=60/(96*g),x=96*w.beats,A=[];if(l.lh.checked)for(var k=0;k<w.loopStart;k++)A.push(k);for(var N=0;N<Number(l.fh.value);N++)for(k=w.loopStart;k<w.loopStart+w.loopLength;k++)A.push(k);if(l.vh.checked)for(k=w.loopStart+w.loopLength;k<w.bars;k++)A.push(k);var E=[{isMeta:!0,channel:-1,midiChannel:-1,isChorus:!1,isDrums:!1},{isMeta:!1,channel:0,midiChannel:0,isChorus:!1,isDrums:!1},{isMeta:!1,channel:0,midiChannel:1,isChorus:!0,isDrums:!1},{isMeta:!1,channel:1,midiChannel:2,isChorus:!1,isDrums:!1},{isMeta:!1,channel:1,midiChannel:3,isChorus:!0,isDrums:!1},{isMeta:!1,channel:2,midiChannel:4,isChorus:!1,isDrums:!1},{isMeta:!1,channel:2,midiChannel:5,isChorus:!0,isDrums:!1},{isMeta:!1,channel:3,midiChannel:6,isChorus:!1,isDrums:!0}];a(1297377380),a(6),c(1),c(E.length),c(96);for(var Z=function(h){a(1297379947);var r=h.isMeta,o=h.channel,g=h.midiChannel,k=h.isChorus,N=h.isDrums,E=i;i=s+=4;var Z=0,R=0,I=function(t){if(t<Z)throw new Error("Midi event time cannot go backwards.");d(t-Z),Z=t};if(r){I(0),c(65281),b("http://www.beepbox.co/#"+w.toBase64String()),I(0),u(16732419),u(M),I(0),u(16734212),f(w.beats),f(2),f(24),f(8);var G=w.scale<10&&1==(1&w.scale),B=11-w.key,S=B;for(1==(1&B)&&(S+=6),G&&(S+=9);S>6;)S-=12;I(0),u(16734466),f(S),f(G?1:0),l.lh.checked&&(R+=x*w.loopStart),I(R),c(65286),b("Loop Start");for(var C=0;C<Number(l.fh.value);C++)I(R+=x*w.loopLength),c(65286),b(C<Number(l.fh.value)-1?"Loop Repeat":"Loop End");if(l.vh.checked&&(R+=x*(w.bars-w.loopStart-w.loopLength)),R!=x*A.length)throw new Error("Miscalculated number of bars.")}else{var j=["blue channel","yellow channel","orange channel","gray channel"][o];k&&(j+=" chorus"),I(0),c(65283),b(j),I(R),f(176|g),v(0,126),v(0,1),I(R),f(176|g),v(0,68),v(0,127);for(var D=-1,U=-1,Y=-1,z=N?33:t.Music.keyTransposes[w.key],L=N?t.Music.drumInterval:1,V=0,F=A;V<F.length;V++){var W=F[V],J=w.getPattern(o,W);if(null!=J){var T=J.instrument;if(k&&0==w.instrumentChorus[o][T]){R+=x;continue}if(D!=T){if(D=T,I(R),c(65284),N){var O="noise: "+t.Music.drumNames[w.instrumentWaves[o][T]];O+=", volume: "+t.Music.volumeNames[w.instrumentVolumes[o][T]],b(O+=", envelope: "+t.Music.envelopeNames[w.instrumentEnvelopes[o][T]]),I(R),f(192|g),v(0,126)}else{O="wave: "+t.Music.waveNames[w.instrumentWaves[o][T]];O+=", volume: "+t.Music.volumeNames[w.instrumentVolumes[o][T]],O+=", envelope: "+t.Music.envelopeNames[w.instrumentEnvelopes[o][T]],O+=", filter: "+t.Music.filterNames[w.instrumentFilters[o][T]],O+=", chorus: "+t.Music.chorusNames[w.instrumentChorus[o][T]],b(O+=", effect: "+t.Music.effectNames[w.instrumentEffects[o][T]]);var P=w.instrumentFilters[o][T]<3?[71,80,70,68,81,81,81,81,74]:[46,46,6,24,25,25,106,106,33];I(R),f(192|g),v(0,P[w.instrumentWaves[o][T]])}var Q=(5-w.instrumentVolumes[o][T])/5;I(R),f(176|g),v(0,7),v(0,Math.round(127*Q))}var X=w.instrumentEffects[o][T],H=t.Music.effectVibratos[X],K=t.Music.effectTremelos[X],_=t.Music.chorusValues[w.instrumentChorus[o][T]];k||(_*=-1),_+=t.Music.chorusOffsets[w.instrumentChorus[o][T]];for(var q=0;q<J.notes.length;q++){for(var $=J.notes[q],tt=R+$.start*p,it=tt,st=$.pins[0].volume,ht=$.pins[0].interval,nt=z+$.pitches[0]*L,et=1;et<$.pins.length;et++){for(var rt=tt+$.pins[et].time*p,ot=$.pins[et].volume,at=$.pins[et].interval,ut=rt-it,lt=0;lt<ut;lt++){var ct=it+lt,ft=e(st,ot,lt/ut),vt=e(ht,at,lt/ut),dt=Math.floor(lt/m)%4,bt=void 0,wt=z+(bt=2==$.pitches.length?$.pitches[dt>>1]:3==$.pitches.length?$.pitches[3==dt?1:dt]:4==$.pitches.length?$.pitches[dt]:$.pitches[0])*L+vt+_,pt=wt-(bt=Math.round(wt)),mt=Math.sin(2*Math.PI*(ct-R)*y/.14);(2!=X||ct-tt>=3*p)&&(pt+=H*mt);var gt=Math.max(0,Math.min(16383,Math.round(8192+4096*pt))),Mt=ft/3,yt=1+K*(mt-1),xt=Math.round(127*Mt*yt);gt!=U&&(I(ct),f(224|g),v(0,127&gt),v(0,gt>>7&127),U=gt),xt!=Y&&(I(ct),f(176|g),v(0,11),v(0,xt),Y=xt),ct==tt?(I(ct),f(144|g),v(0,bt),v(0,64)):bt!=nt&&(I(ct),f(144|g),v(0,bt),v(0,64),I(ct),f(128|g),v(0,nt),v(0,64)),nt=bt}it=rt,st=ot,ht=at}I(R+$.end*p),f(128|g),v(0,nt),v(0,64)}}R+=x}}I(R),u(16723712),n.setUint32(E,i-E-4,!1)},R=0,I=E;R<I.length;R++){Z(I[R])}h=ArrayBuffer.transfer(h,s),r(new Blob([h],{type:"audio/midi"}),l.uh.value.trim()+".midi"),l.nh()},this.Mh=function(){var t=l.Zt.song.toJsonObject(l.lh.checked,Number(l.fh.value),l.vh.checked),i=JSON.stringify(t,null,"\t");r(new Blob([i],{type:"application/json"}),l.uh.value.trim()+".json"),l.nh()},this.fh.value="1",0==this.Zt.song.loopStart?(this.lh.checked=!1,this.lh.disabled=!0):(this.lh.checked=!0,this.lh.disabled=!1),this.Zt.song.loopStart+this.Zt.song.loopLength==this.Zt.song.bars?(this.vh.checked=!1,this.vh.disabled=!0):(this.vh.checked=!0,this.vh.disabled=!1),this.uh.addEventListener("input",o.ph),this.fh.addEventListener("blur",o.oh),this.dh.addEventListener("click",this.mh),this.bh.addEventListener("click",this.gh),this.wh.addEventListener("click",this.Mh),this.hh.addEventListener("click",this.nh)}return o.ph=function(t){var i=t.target,s=/[\+\*\$\?\|\{\}\\\/<>#%!`&'"=:@]/gi;if(s.test(i.value)){var h=i.selectionStart;i.value=i.value.replace(s,""),h--,i.setSelectionRange(h,h)}},o.oh=function(t){var i=t.target;i.value=Math.floor(Math.max(Number(i.min),Math.min(Number(i.max),Number(i.value))))+""},o}();t.ExportPrompt=o}(beepbox||(beepbox={})),function(t){var i=t.html.button,s=t.html.div,h=t.html.input,n=t.html.text,e=function(){return function(e,r){var o=this;this.Zt=e,this.Ui=r,this.yh=h({type:"file",accept:".json,application/json"}),this.hh=i({},[n("Cancel")]),this.container=s({className:"prompt",style:"width: 200px;"},[s({style:"font-size: 2em"},[n("Import")]),s(void 0,[n("BeepBox songs can be exported and re-imported as .json files. You could also use other means to make .json files for BeepBox as long as they follow the same structure.")]),this.yh,this.hh]),this.nh=function(){o.Zt.undo()},this.cleanUp=function(){o.yh.removeEventListener("change",o.xh),o.hh.removeEventListener("click",o.nh)},this.xh=function(){var i=o.yh.files[0];if(i){var s=new FileReader;s.addEventListener("load",function(i){o.Zt.prompt=null,o.Zt.history.record(new t.ChangeSong(o.Zt,s.result),!0)}),s.readAsText(i)}},this.yh.addEventListener("change",this.xh),this.hh.addEventListener("click",this.nh)}}();t.ImportPrompt=e}(beepbox||(beepbox={})),function(t){var i=t.html.button,s=t.html.div,h=t.html.span,n=t.html.select,e=t.html.option,r=t.html.input,o=t.html.text;function a(t,i){for(var s=0,h=i;s<h.length;s++){var n=h[s];t.appendChild(e(n,n,!1,!1))}return t}function u(t,i){t.selectedIndex!=i&&(t.selectedIndex=i)}var l=function(){function l(c){var f=this;this.Zt=c,this.prompt=null,this.Ah=700,this.kh=645,this.Nh=new t.PatternEditor(this.Zt),this.Eh=new t.TrackEditor(this.Zt,this),this.Zh=new t.LoopEditor(this.Zt),this.Rh=new t.BarScrollBar(this.Zt),this.Ih=new t.OctaveScrollBar(this.Zt),this.Gh=new t.Piano(this.Zt),this.Bh=s({style:"width: 512px; height: 645px;"},[s({style:"width: 512px; height: 481px; display: flex; flex-direction: row;"},[this.Gh.container,this.Nh.container,this.Ih.container]),s({style:"width: 512px; height: 6px;"}),s({style:"width: 512px; height: 158px;"},[this.Eh.container,s({style:"width: 512px; height: 5px;"}),this.Zh.container,s({style:"width: 512px; height: 5px;"}),this.Rh.container])]),this.Sh=i({style:"width: 34px; margin: 0px",type:"button"}),this.Ch=r({style:"width: 9em; flex-shrink: 0; margin: 0px;",type:"range",min:"0",max:"100",value:"50",step:"1"}),this.jh=n({style:"width:100%;"},[e("","Edit Menu",!0,!0),e("undo","Undo (Z)",!1,!1),e("redo","Redo (Y)",!1,!1),e("copy","Copy Pattern (C)",!1,!1),e("paste","Paste Pattern (V)",!1,!1),e("transposeUp","Shift Notes Up (+)",!1,!1),e("transposeDown","Shift Notes Down (-)",!1,!1),e("duration","Custom song size...",!1,!1),e("import","Import JSON...",!1,!1),e("clean","Clean Slate",!1,!1)]),this.Dh=n({style:"width:100%;"},[e("","Preferences Menu",!0,!0),e("showLetters","Show Piano",!1,!1),e("showFifth","Highlight 'Fifth' Notes",!1,!1),e("showChannels","Show All Channels",!1,!1),e("showScrollBar","Octave Scroll Bar",!1,!1)]),this.Uh=i({style:"margin: 5px 0;",type:"button"},[o("Export")]),this.Yh=a(n({style:"width:9em;"}),t.Music.scaleNames),this.zh=a(n({style:"width:9em;"}),t.Music.keyNames),this.Lh=r({style:"width: 9em; margin: 0px;",type:"range",min:"0",max:"11",value:"7",step:"1"}),this.Vh=r({style:"width: 9em; margin: 0px;",type:"range",min:"0",max:"3",value:"0",step:"1"}),this.Fh=a(n({style:"width:9em;"}),t.Music.partNames),this.Wh=s({style:"visibility: hidden; margin: 3px 0; text-align: center;"},[o("Pattern Settings")]),this.Jh=n({style:"width:9em;"}),this.Th=s({className:"selectRow",style:"visibility: hidden;"},[h({},[o("Instrument: ")]),s({className:"selectContainer"},[this.Jh])]),this.Oh=s({style:"margin: 3px 0; text-align: center;"},[o("Instrument Settings")]),this.Ph=r({style:"width: 9em; margin: 0px;",type:"range",min:"-5",max:"0",value:"0",step:"1"}),this.Qh=a(n({style:"width:9em;"}),t.Music.waveNames),this.Xh=a(n({style:"width:9em;"}),t.Music.drumNames),this.Hh=a(n({style:"width:9em;"}),t.Music.envelopeNames),this.Kh=a(n({style:"width:9em;"}),t.Music.filterNames),this._h=s({className:"selectRow"},[h({},[o("Filter: ")]),s({className:"selectContainer"},[this.Kh])]),this.qh=a(n({style:"width:9em;"}),t.Music.chorusNames),this.$h=s({className:"selectRow"},[h({},[o("Chorus: ")]),s({className:"selectContainer"},[this.qh])]),this.tn=a(n({style:"width:9em;"}),t.Music.effectNames),this.in=s({className:"selectRow"},[h({},[o("Effect: ")]),s({className:"selectContainer"},[this.tn])]),this.sn=s({},[s({className:"selectRow"},[h({},[o("Volume: ")]),this.Ph]),s({className:"selectRow"},[h({},[o("Wave: ")]),s({className:"selectContainer"},[this.Qh,this.Xh])]),s({className:"selectRow"},[h({},[o("Envelope: ")]),s({className:"selectContainer"},[this.Hh])]),this._h,this.$h,this.in]),this.hn=s({className:"promptContainer",style:"display: none;"}),this.mainLayer=s({className:"beepboxEditor",tabIndex:"0"},[this.Bh,s({className:"editor-right-side"},[s({style:"text-align: center; color: #999;"},[o("BeepBox 2.1.4")]),s({style:"margin: 5px 0; display: flex; flex-direction: row; align-items: center;"},[this.Sh,s({style:"width: 1px; height: 10px;"}),t.svgElement("svg",{width:"2em",height:"2em",viewBox:"0 0 26 26"},[t.svgElement("path",{d:"M 4 17 L 4 9 L 8 9 L 12 5 L 12 21 L 8 17 z",fill:"#777"}),t.svgElement("path",{d:"M 15 11 L 16 10 A 7.2 7.2 0 0 1 16 16 L 15 15 A 5.8 5.8 0 0 0 15 12 z",fill:"#777"}),t.svgElement("path",{d:"M 18 8 L 19 7 A 11.5 11.5 0 0 1 19 19 L 18 18 A 10.1 10.1 0 0 0 18 8 z",fill:"#777"})]),s({style:"width: 1px; height: 10px;"}),this.Ch]),s({className:"selectContainer",style:"margin: 5px 0;"},[this.jh]),s({className:"selectContainer",style:"margin: 5px 0;"},[this.Dh]),this.Uh,s({style:"flex: 1 1 110px;"}),s({style:"margin: 3px 0; text-align: center;"},[o("Song Settings")]),s({className:"selectRow"},[h({},[o("Scale: ")]),s({className:"selectContainer"},[this.Yh])]),s({className:"selectRow"},[h({},[o("Key: ")]),s({className:"selectContainer"},[this.zh])]),s({className:"selectRow"},[h({},[o("Tempo: ")]),this.Lh]),s({className:"selectRow"},[h({},[o("Reverb: ")]),this.Vh]),s({className:"selectRow"},[h({},[o("Rhythm: ")]),s({className:"selectContainer"},[this.Fh])]),s({style:"flex: 1 1 25px;"}),this.Wh,this.Th,s({style:"flex: 1 1 25px;"}),this.Oh,this.sn]),this.hn]),this.nn=null,this.en=null,this.rn=null,this.on=null,this.an=function(t){f.mainLayer.focus()},this.un=function(){for(var i=[(f.Zt.showLetters?"✓ ":"")+"Show Piano",(f.Zt.showFifth?"✓ ":"")+"Highlight 'Fifth' Notes",(f.Zt.showChannels?"✓ ":"")+"Show All Channels",(f.Zt.showScrollBar?"✓ ":"")+"Octave Scroll Bar"],s=0;s<i.length;s++){var h=f.Dh.children[s+1];h.innerText!=i[s]&&(h.innerText=i[s])}u(f.Yh,f.Zt.song.scale),u(f.zh,f.Zt.song.key),f.Lh.value=""+f.Zt.song.tempo,f.Vh.value=""+f.Zt.song.reverb,u(f.Fh,t.Music.partCounts.indexOf(f.Zt.song.parts)),3==f.Zt.channel?(f._h.style.visibility="hidden",f.$h.style.visibility="hidden",f.in.style.visibility="hidden",f.Qh.style.display="none",f.Xh.style.display="block"):(f._h.style.visibility="visible",f.$h.style.visibility="visible",f.in.style.visibility="visible",f.Qh.style.display="block",f.Xh.style.display="none");var n=f.Zt.getCurrentPattern();if(f.Wh.style.visibility=f.Zt.song.instruments>1&&null!=n?"visible":"hidden",f.Th.style.visibility=f.Zt.song.instruments>1&&null!=n?"visible":"hidden",f.Jh.children.length!=f.Zt.song.instruments){for(;f.Jh.firstChild;)f.Jh.removeChild(f.Jh.firstChild);var e=[];for(s=0;s<f.Zt.song.instruments;s++)e.push(s+1);a(f.Jh,e)}f.sn.style.color=l.noteColorsBright[f.Zt.channel];var r=f.Zt.getCurrentInstrument();u(f.Qh,f.Zt.song.instrumentWaves[f.Zt.channel][r]),u(f.Xh,f.Zt.song.instrumentWaves[f.Zt.channel][r]),u(f.Kh,f.Zt.song.instrumentFilters[f.Zt.channel][r]),u(f.Hh,f.Zt.song.instrumentEnvelopes[f.Zt.channel][r]),u(f.tn,f.Zt.song.instrumentEffects[f.Zt.channel][r]),u(f.qh,f.Zt.song.instrumentChorus[f.Zt.channel][r]),f.Ph.value=-f.Zt.song.instrumentVolumes[f.Zt.channel][r]+"",u(f.Jh,r),f.Gh.container.style.display=f.Zt.showLetters?"block":"none",f.Ih.container.style.display=f.Zt.showScrollBar?"block":"none",f.Rh.container.style.display=f.Zt.song.bars>16?"block":"none";var o=512;f.Zt.showLetters&&(o-=32),f.Zt.showScrollBar&&(o-=20),f.Nh.container.style.width=String(o)+"px";var c=128;f.Zt.song.bars>16&&(c-=20),f.Eh.container.style.height=String(c)+"px",f.Ch.value=String(f.Zt.volume),f.ln(f.Zt.prompt)},this.cn=function(t){if(f.prompt)27==t.keyCode&&window.history.back();else switch(f.Eh.onKeyPressed(t),t.keyCode){case 32:f.fn(),t.preventDefault();break;case 90:t.shiftKey?f.Zt.redo():f.Zt.undo(),t.preventDefault();break;case 89:f.Zt.redo(),t.preventDefault();break;case 67:f.vn(),t.preventDefault();break;case 86:f.dn(),t.preventDefault();break;case 219:f.Zt.synth.prevBar(),t.preventDefault();break;case 221:f.Zt.synth.nextBar(),t.preventDefault();break;case 189:case 173:f.bn(!1),t.preventDefault();break;case 187:case 61:f.bn(!0),t.preventDefault()}},this.fn=function(){f.Zt.synth.playing?f.wn():f.pn()},this.mn=function(){f.Zt.setVolume(Number(f.Ch.value))},this.gn=function(){f.Mn("export")},this.yn=function(){f.Zt.history.record(new t.ChangeScale(f.Zt,f.Yh.selectedIndex))},this.xn=function(){f.Zt.history.record(new t.ChangeKey(f.Zt,f.zh.selectedIndex))},this.An=function(){var i=f.Zt.history.lastChangeWas(f.en),s=i?f.en.oldValue:f.Zt.song.tempo;f.en=new t.ChangeTempo(f.Zt,s,parseInt(f.Lh.value)),f.Zt.history.record(f.en,i)},this.kn=function(){var i=f.Zt.history.lastChangeWas(f.rn),s=i?f.rn.oldValue:f.Zt.song.reverb;f.rn=new t.ChangeReverb(f.Zt,s,parseInt(f.Vh.value)),f.Zt.history.record(f.rn,i)},this.Nn=function(){f.Zt.history.record(new t.ChangeParts(f.Zt,t.Music.partCounts[f.Fh.selectedIndex]))},this.En=function(){f.Zt.history.record(new t.ChangeWave(f.Zt,f.Qh.selectedIndex))},this.Zn=function(){f.Zt.history.record(new t.ChangeWave(f.Zt,f.Xh.selectedIndex))},this.Rn=function(){f.Zt.history.record(new t.ChangeFilter(f.Zt,f.Kh.selectedIndex))},this.In=function(){f.Zt.history.record(new t.ChangeEnvelope(f.Zt,f.Hh.selectedIndex))},this.Gn=function(){f.Zt.history.record(new t.ChangeEffect(f.Zt,f.tn.selectedIndex))},this.Bn=function(){f.Zt.history.record(new t.ChangeChorus(f.Zt,f.qh.selectedIndex))},this.Sn=function(){var i=f.Zt.history.lastChangeWas(f.on),s=i?f.on.oldValue:f.Zt.song.instrumentVolumes[f.Zt.channel][f.Zt.getCurrentInstrument()];f.on=new t.ChangeVolume(f.Zt,s,-parseInt(f.Ph.value)),f.Zt.history.record(f.on,i)},this.Cn=function(){var i=f.Zt.getCurrentPattern();null!=i&&f.Zt.history.record(new t.ChangePatternInstrument(f.Zt,f.Jh.selectedIndex,i))},this.jn=function(t){switch(f.jh.value){case"undo":f.Zt.undo();break;case"redo":f.Zt.redo();break;case"copy":f.vn();break;case"paste":f.dn();break;case"transposeUp":f.bn(!0);break;case"transposeDown":f.bn(!1);break;case"import":f.Mn("import");break;case"clean":f.Dn();break;case"duration":f.Mn("duration")}f.jh.selectedIndex=0},this.Un=function(t){switch(f.Dh.value){case"showLetters":f.Zt.showLetters=!f.Zt.showLetters;break;case"showFifth":f.Zt.showFifth=!f.Zt.showFifth;break;case"showChannels":f.Zt.showChannels=!f.Zt.showChannels;break;case"showScrollBar":f.Zt.showScrollBar=!f.Zt.showScrollBar}f.Dh.selectedIndex=0,f.Zt.notifier.changed(),f.Zt.savePreferences()},this.Zt.notifier.watch(this.un),this.un(),this.jh.addEventListener("change",this.jn),this.Dh.addEventListener("change",this.Un),this.Yh.addEventListener("change",this.yn),this.zh.addEventListener("change",this.xn),this.Lh.addEventListener("input",this.An),this.Vh.addEventListener("input",this.kn),this.Fh.addEventListener("change",this.Nn),this.Jh.addEventListener("change",this.Cn),this.Ph.addEventListener("input",this.Sn),this.Qh.addEventListener("change",this.En),this.Xh.addEventListener("change",this.Zn),this.Hh.addEventListener("change",this.In),this.Kh.addEventListener("change",this.Rn),this.qh.addEventListener("change",this.Bn),this.tn.addEventListener("change",this.Gn),this.Sh.addEventListener("click",this.fn),this.Uh.addEventListener("click",this.gn),this.Ch.addEventListener("input",this.mn),this.Bh.addEventListener("mousedown",this.an),this.mainLayer.addEventListener("keydown",this.cn)}return l.prototype.Mn=function(t){this.Zt.openPrompt(t),this.ln(t)},l.prototype.ln=function(i){if(this.prompt&&(this.Yn&&this.pn(),this.Yn=!1,this.hn.style.display="none",this.hn.removeChild(this.prompt.container),this.prompt.cleanUp(),this.prompt=null,this.mainLayer.focus()),i){switch(i){case"export":this.prompt=new t.ExportPrompt(this.Zt,this);break;case"import":this.prompt=new t.ImportPrompt(this.Zt,this);break;case"duration":this.prompt=new t.SongDurationPrompt(this.Zt,this)}this.prompt&&(this.Yn=this.Zt.synth.playing,this.wn(),this.hn.style.display=null,this.hn.appendChild(this.prompt.container))}},l.prototype.updatePlayButton=function(){this.Zt.synth.playing?(this.Sh.classList.remove("playButton"),this.Sh.classList.add("pauseButton")):(this.Sh.classList.remove("pauseButton"),this.Sh.classList.add("playButton"))},l.prototype.pn=function(){this.Zt.synth.play(),this.updatePlayButton()},l.prototype.wn=function(){this.Zt.synth.pause(),this.Zt.synth.snapToBar(),this.updatePlayButton()},l.prototype.vn=function(){var t=this.Zt.getCurrentPattern();if(null!=t){var i={notes:t.notes,beats:this.Zt.song.beats,parts:this.Zt.song.parts,drums:3==this.Zt.channel};window.localStorage.setItem("patternCopy",JSON.stringify(i))}},l.prototype.dn=function(){var i=this.Zt.getCurrentPattern();if(null!=i){var s=JSON.parse(String(window.localStorage.getItem("patternCopy")));null!=s&&s.drums==(3==this.Zt.channel)&&this.Zt.history.record(new t.ChangePaste(this.Zt,i,s.notes,s.beats,s.parts))}},l.prototype.Dn=function(){this.Zt.history.record(new t.ChangeSong(this.Zt,"")),this.Nh.resetCopiedPins()},l.prototype.bn=function(i){var s=this.Zt.getCurrentPattern();if(null!=s){var h=this.Zt.history.lastChangeWas(this.nn);this.nn=new t.ChangeTranspose(this.Zt,s,i),this.Zt.history.record(this.nn,h)}},l.channelColorsDim=["#0099a1","#a1a100","#c75000","#6f6f6f"],l.channelColorsBright=["#25f3ff","#ffff25","#ff9752","#aaaaaa"],l.noteColorsDim=["#00bdc7","#c7c700","#ff771c","#aaaaaa"],l.noteColorsBright=["#92f9ff","#ffff92","#ffcdab","#eeeeee"],l}();t.SongEditor=l;var c=new t.SongDocument(location.hash),f=new l(c);if(document.getElementById("beepboxEditorContainer").appendChild(f.mainLayer),f.mainLayer.focus(),!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|android|ipad|playbook|silk/i.test(navigator.userAgent)){function v(){document.hidden||(c.synth.play(),f.updatePlayButton(),window.removeEventListener("visibilitychange",v))}document.hidden?window.addEventListener("visibilitychange",v):v()}}(beepbox||(beepbox={}));